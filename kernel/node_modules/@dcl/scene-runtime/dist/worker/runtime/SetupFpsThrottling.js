"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.setupFpsThrottling = void 0;
const ecs_math_1 = require("@dcl/ecs-math");
function setupFpsThrottling(dcl, parcels, onChangeUpdateInterval) {
    dcl.subscribe('positionChanged');
    dcl.onEvent((event) => {
        if (event.type !== 'positionChanged') {
            return;
        }
        const e = event.data;
        //NOTE: calling worldToGrid from parcelScenePositions.ts here crashes kernel when there are 80+ workers since chrome 92.
        const PARCEL_SIZE = 16;
        const playerPosition = new ecs_math_1.Vector2(Math.floor(e.cameraPosition.x / PARCEL_SIZE), Math.floor(e.cameraPosition.z / PARCEL_SIZE));
        if (playerPosition === undefined) {
            return;
        }
        const playerPos = playerPosition;
        let sqrDistanceToPlayerInParcels = 10 * 10;
        let isInsideScene = false;
        for (const parcel of parcels) {
            sqrDistanceToPlayerInParcels = Math.min(sqrDistanceToPlayerInParcels, ecs_math_1.Vector2.DistanceSquared(playerPos, parcel));
            if (parcel.x === playerPos.x && parcel.y === playerPos.y) {
                isInsideScene = true;
            }
        }
        let fps = 1;
        if (isInsideScene) {
            fps = 30;
        }
        else if (sqrDistanceToPlayerInParcels <= 2 * 2) {
            // NOTE(Brian): Yes, this could be a formula, but I prefer this pedestrian way as
            //              its easier to read and tweak (i.e. if we find out its better as some arbitrary curve, etc).
            fps = 20;
        }
        else if (sqrDistanceToPlayerInParcels <= 3 * 3) {
            fps = 10;
        }
        else if (sqrDistanceToPlayerInParcels <= 4 * 4) {
            fps = 5;
        }
        onChangeUpdateInterval(1000 / fps);
    });
}
exports.setupFpsThrottling = setupFpsThrottling;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2V0dXBGcHNUaHJvdHRsaW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3dvcmtlci9ydW50aW1lL1NldHVwRnBzVGhyb3R0bGluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw0Q0FBd0M7QUFFeEMsU0FBZ0Isa0JBQWtCLENBQ2hDLEdBQTBCLEVBQzFCLE9BQXdDLEVBQ3hDLHNCQUFrRDtJQUVsRCxHQUFHLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUFDLENBQUE7SUFDaEMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO1FBQ3BCLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxpQkFBaUIsRUFBRTtZQUNwQyxPQUFNO1NBQ1A7UUFFRCxNQUFNLENBQUMsR0FBRyxLQUFLLENBQUMsSUFBa0MsQ0FBQTtRQUVsRCx3SEFBd0g7UUFDeEgsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFBO1FBQ3RCLE1BQU0sY0FBYyxHQUFHLElBQUksa0JBQU8sQ0FDaEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsR0FBRyxXQUFXLENBQUMsRUFDNUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsR0FBRyxXQUFXLENBQUMsQ0FDN0MsQ0FBQTtRQUVELElBQUksY0FBYyxLQUFLLFNBQVMsRUFBRTtZQUNoQyxPQUFNO1NBQ1A7UUFFRCxNQUFNLFNBQVMsR0FBRyxjQUF5QixDQUFBO1FBRTNDLElBQUksNEJBQTRCLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQTtRQUMxQyxJQUFJLGFBQWEsR0FBRyxLQUFLLENBQUE7UUFFekIsS0FBSyxNQUFNLE1BQU0sSUFBSSxPQUFPLEVBQUU7WUFDNUIsNEJBQTRCLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsRUFBRSxrQkFBTyxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQTtZQUNqSCxJQUFJLE1BQU0sQ0FBQyxDQUFDLEtBQUssU0FBUyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3hELGFBQWEsR0FBRyxJQUFJLENBQUE7YUFDckI7U0FDRjtRQUVELElBQUksR0FBRyxHQUFXLENBQUMsQ0FBQTtRQUVuQixJQUFJLGFBQWEsRUFBRTtZQUNqQixHQUFHLEdBQUcsRUFBRSxDQUFBO1NBQ1Q7YUFBTSxJQUFJLDRCQUE0QixJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDaEQsaUZBQWlGO1lBQ2pGLDJHQUEyRztZQUMzRyxHQUFHLEdBQUcsRUFBRSxDQUFBO1NBQ1Q7YUFBTSxJQUFJLDRCQUE0QixJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDaEQsR0FBRyxHQUFHLEVBQUUsQ0FBQTtTQUNUO2FBQU0sSUFBSSw0QkFBNEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2hELEdBQUcsR0FBRyxDQUFDLENBQUE7U0FDUjtRQUVELHNCQUFzQixDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQTtJQUNwQyxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFwREQsZ0RBb0RDIn0=