"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.prepareSandboxContext = exports.customEval = void 0;
const Fetch_1 = require("./Fetch");
const WebSocket_1 = require("./WebSocket");
const allowListES5 = [
    'eval',
    'parseInt',
    'parseFloat',
    'isNaN',
    'isFinite',
    'decodeURI',
    'decodeURIComponent',
    'encodeURI',
    'encodeURIComponent',
    'escape',
    'unescape',
    'Object',
    'Function',
    'String',
    'Boolean',
    'Number',
    'Math',
    'Date',
    'RegExp',
    'Error',
    'EvalError',
    'RangeError',
    'ReferenceError',
    'SyntaxError',
    'TypeError',
    'URIError',
    'JSON',
    'Array',
    'Promise',
    'NaN',
    'Infinity'
];
// eslint-disable-next-line @typescript-eslint/ban-types
const defer = Promise.resolve().then.bind(Promise.resolve());
async function customEval(code, context) {
    const sandbox = {};
    const resultKey = 'SAFE_EVAL_' + Math.floor(Math.random() * 1000000);
    sandbox[resultKey] = {};
    Object.keys(context).forEach(function (key) {
        sandbox[key] = context[key];
    });
    sandbox.window = sandbox;
    sandbox.self = sandbox;
    return defer(() => new Function('code', `with (this) { ${code} }`).call(sandbox, code));
}
exports.customEval = customEval;
function getES5Context(base) {
    // globalThis shouldn't crash here, as allowListES5 is an array of `keyof typeof globalThis`
    allowListES5.forEach(($) => (base[$] = globalThis[$]));
    return base;
}
function prepareSandboxContext(options) {
    const originalFetch = globalThis.fetch;
    const restrictedWebSocket = (0, WebSocket_1.createWebSocket)(options);
    const restrictedFetch = (0, Fetch_1.createFetch)({ ...options, originalFetch });
    globalThis.fetch = restrictedFetch;
    globalThis.WebSocket = restrictedWebSocket;
    const env = { dcl: options.dcl, WebSocket: restrictedWebSocket, fetch: restrictedFetch };
    return getES5Context(env);
}
exports.prepareSandboxContext = prepareSandboxContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FuZGJveC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy93b3JrZXIvc2FuZGJveC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBcUM7QUFDckMsMkNBQTZDO0FBRTdDLE1BQU0sWUFBWSxHQUFtQztJQUNuRCxNQUFNO0lBQ04sVUFBVTtJQUNWLFlBQVk7SUFDWixPQUFPO0lBQ1AsVUFBVTtJQUNWLFdBQVc7SUFDWCxvQkFBb0I7SUFDcEIsV0FBVztJQUNYLG9CQUFvQjtJQUNwQixRQUFRO0lBQ1IsVUFBVTtJQUNWLFFBQVE7SUFDUixVQUFVO0lBQ1YsUUFBUTtJQUNSLFNBQVM7SUFDVCxRQUFRO0lBQ1IsTUFBTTtJQUNOLE1BQU07SUFDTixRQUFRO0lBQ1IsT0FBTztJQUNQLFdBQVc7SUFDWCxZQUFZO0lBQ1osZ0JBQWdCO0lBQ2hCLGFBQWE7SUFDYixXQUFXO0lBQ1gsVUFBVTtJQUNWLE1BQU07SUFDTixPQUFPO0lBQ1AsU0FBUztJQUNULEtBQUs7SUFDTCxVQUFVO0NBQ1gsQ0FBQTtBQUVELHdEQUF3RDtBQUN4RCxNQUFNLEtBQUssR0FBNEIsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBUyxDQUFDLENBQUE7QUFFN0YsS0FBSyxVQUFVLFVBQVUsQ0FBQyxJQUFZLEVBQUUsT0FBWTtJQUN6RCxNQUFNLE9BQU8sR0FBUSxFQUFFLENBQUE7SUFFdkIsTUFBTSxTQUFTLEdBQUcsWUFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxDQUFBO0lBQ3BFLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUE7SUFFdkIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHO1FBQ3hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDN0IsQ0FBQyxDQUFDLENBQUE7SUFFRixPQUFPLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQTtJQUN4QixPQUFPLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQTtJQUV0QixPQUFPLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxNQUFNLEVBQUUsaUJBQWlCLElBQUksSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFBO0FBQ3pGLENBQUM7QUFkRCxnQ0FjQztBQUVELFNBQVMsYUFBYSxDQUFDLElBQXlCO0lBQzlDLDRGQUE0RjtJQUM1RixZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBSSxVQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUUvRCxPQUFPLElBQUksQ0FBQTtBQUNiLENBQUM7QUFFRCxTQUFnQixxQkFBcUIsQ0FBQyxPQU1yQztJQUNDLE1BQU0sYUFBYSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUE7SUFFdEMsTUFBTSxtQkFBbUIsR0FBRyxJQUFBLDJCQUFlLEVBQUMsT0FBTyxDQUFDLENBQUE7SUFDcEQsTUFBTSxlQUFlLEdBQUcsSUFBQSxtQkFBVyxFQUFDLEVBQUUsR0FBRyxPQUFPLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FFakU7SUFBQyxVQUFrQixDQUFDLEtBQUssR0FBRyxlQUFlLENBQUE7SUFDNUMsVUFBVSxDQUFDLFNBQVMsR0FBRyxtQkFBbUIsQ0FBQTtJQUUxQyxNQUFNLEdBQUcsR0FBRyxFQUFFLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRyxFQUFFLFNBQVMsRUFBRSxtQkFBbUIsRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLENBQUE7SUFFeEYsT0FBTyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDM0IsQ0FBQztBQWxCRCxzREFrQkMifQ==