"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.initMessagesFinished = exports.getIdAsNumber = exports.numberToIdStore = exports.resolveMapping = exports.componentNameRE = exports.generatePBObject = exports.componentSerializeOpt = void 0;
const ecs_math_1 = require("@dcl/ecs-math");
const engine_api_gen_1 = require("@dcl/protocol/out-ts/decentraland/kernel/apis/engine_api.gen");
const engine_interface_gen_1 = require("@dcl/protocol/out-ts/decentraland/renderer/engine_interface.gen");
const VECTOR3_MEMBER_CAP = 1000000; // Value measured when genesis plaza glitch triggered a physics engine breakdown
const pbTransform = {
    position: ecs_math_1.Vector3.Zero(),
    rotation: ecs_math_1.Quaternion.Identity,
    scale: ecs_math_1.Vector3.One()
};
const TRANSFORM_CLASS_ID = 1;
const transformData = new ArrayBuffer(40);
const transformView = new DataView(transformData);
exports.componentSerializeOpt = {
    useBinaryTransform: true
};
function generatePBObject(classId, json) {
    if (classId === TRANSFORM_CLASS_ID) {
        const transform = JSON.parse(json);
        if (!exports.componentSerializeOpt.useBinaryTransform)
            return serializeTransform(transform);
        else
            return serializeTransformNoProtobuff(transform);
    }
    return json;
}
exports.generatePBObject = generatePBObject;
function serializeTransform(transform) {
    // Position
    // If we don't cap these vectors, scenes may trigger a physics breakdown when messaging enormous values
    pbTransform.position.set(Math.fround(transform.position.x), Math.fround(transform.position.y), Math.fround(transform.position.z));
    capVector(pbTransform.position, VECTOR3_MEMBER_CAP);
    // Rotation
    pbTransform.rotation.copyFrom(transform.rotation);
    // Scale
    pbTransform.scale.set(Math.fround(transform.scale.x), Math.fround(transform.scale.y), Math.fround(transform.scale.z));
    capVector(pbTransform.scale, VECTOR3_MEMBER_CAP);
    const arrayBuffer = engine_interface_gen_1.PBTransform.encode(pbTransform).finish();
    return btoa(String.fromCharCode(...arrayBuffer));
}
function serializeTransformNoProtobuff(transform) {
    // Position
    // If we don't cap these vectors, scenes may trigger a physics breakdown when messaging enormous values
    const cappedVector = new ecs_math_1.Vector3(Math.fround(transform.position.x), Math.fround(transform.position.y), Math.fround(transform.position.z));
    capVector(cappedVector, VECTOR3_MEMBER_CAP);
    let offset = 0;
    transformView.setFloat32(offset, cappedVector.x, true);
    transformView.setFloat32((offset += 4), cappedVector.y, true);
    transformView.setFloat32((offset += 4), cappedVector.z, true);
    // Rotation
    transformView.setFloat32((offset += 4), transform.rotation.x, true);
    transformView.setFloat32((offset += 4), transform.rotation.y, true);
    transformView.setFloat32((offset += 4), transform.rotation.z, true);
    transformView.setFloat32((offset += 4), transform.rotation.w, true);
    // Scale
    cappedVector.set(Math.fround(transform.scale.x), Math.fround(transform.scale.y), Math.fround(transform.scale.z));
    capVector(cappedVector, VECTOR3_MEMBER_CAP);
    transformView.setFloat32((offset += 4), cappedVector.x, true);
    transformView.setFloat32((offset += 4), cappedVector.y, true);
    transformView.setFloat32((offset += 4), cappedVector.z, true);
    const arrayBuffer = new Uint8Array(transformData);
    const base64Value = btoa(String.fromCharCode(...arrayBuffer));
    return base64Value;
}
function capVector(targetVector, cap) {
    if (Math.abs(targetVector.x) > cap) {
        targetVector.x = cap * Math.sign(targetVector.x);
    }
    if (Math.abs(targetVector.y) > cap) {
        targetVector.y = cap * Math.sign(targetVector.y);
    }
    if (Math.abs(targetVector.z) > cap) {
        targetVector.z = cap * Math.sign(targetVector.z);
    }
}
const dataUrlRE = /^data:[^/]+\/[^;]+;base64,/;
const blobRE = /^blob:http/;
exports.componentNameRE = /^(engine\.)/;
function resolveMapping(mapping, mappingName, baseUrl) {
    let url = mappingName;
    if (mapping) {
        url = mapping;
    }
    if (dataUrlRE.test(url)) {
        return url;
    }
    if (blobRE.test(url)) {
        return url;
    }
    return (baseUrl.endsWith('/') ? baseUrl : baseUrl + '/') + url;
}
exports.resolveMapping = resolveMapping;
// NOTE(Brian): The idea is to map all string ids used by this scene to ints
//              so we avoid sending/processing big ids like "xxxxx-xxxxx-xxxxx-xxxxx"
//              that are used by i.e. raycasting queries.
const idToNumberStore = {};
exports.numberToIdStore = {};
let idToNumberStoreCounter = 10; // Starting in 10, to leave room for special cases (such as the root entity)
function addIdToStorage(id, idAsNumber) {
    idToNumberStore[id] = idAsNumber;
    exports.numberToIdStore[idAsNumber] = id;
}
function getIdAsNumber(id) {
    if (!idToNumberStore.hasOwnProperty(id)) {
        idToNumberStoreCounter++;
        addIdToStorage(id, idToNumberStoreCounter);
        return idToNumberStoreCounter;
    }
    else {
        return idToNumberStore[id];
    }
}
exports.getIdAsNumber = getIdAsNumber;
function initMessagesFinished() {
    return {
        type: engine_api_gen_1.EAType.EAT_INIT_MESSAGES_FINISHED,
        tag: 'scene',
        payload: { initMessagesFinished: {} }
    };
}
exports.initMessagesFinished = initMessagesFinished;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvd29ya2VyL1V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDRDQUFtRDtBQUNuRCxpR0FBcUY7QUFDckYsMEdBQTZGO0FBUTdGLE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFBLENBQUMsZ0ZBQWdGO0FBQ25ILE1BQU0sV0FBVyxHQUFjO0lBQzdCLFFBQVEsRUFBRSxrQkFBTyxDQUFDLElBQUksRUFBRTtJQUN4QixRQUFRLEVBQUUscUJBQVUsQ0FBQyxRQUFRO0lBQzdCLEtBQUssRUFBRSxrQkFBTyxDQUFDLEdBQUcsRUFBRTtDQUNaLENBQUE7QUFFVixNQUFNLGtCQUFrQixHQUFHLENBQUMsQ0FBQTtBQUU1QixNQUFNLGFBQWEsR0FBZ0IsSUFBSSxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUE7QUFDdEQsTUFBTSxhQUFhLEdBQWEsSUFBSSxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUE7QUFFOUMsUUFBQSxxQkFBcUIsR0FBRztJQUNuQyxrQkFBa0IsRUFBRSxJQUFJO0NBQ3pCLENBQUE7QUFFRCxTQUFnQixnQkFBZ0IsQ0FBQyxPQUFlLEVBQUUsSUFBWTtJQUM1RCxJQUFJLE9BQU8sS0FBSyxrQkFBa0IsRUFBRTtRQUNsQyxNQUFNLFNBQVMsR0FBYyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzdDLElBQUksQ0FBQyw2QkFBcUIsQ0FBQyxrQkFBa0I7WUFBRSxPQUFPLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxDQUFBOztZQUM5RSxPQUFPLDZCQUE2QixDQUFDLFNBQVMsQ0FBQyxDQUFBO0tBQ3JEO0lBRUQsT0FBTyxJQUFJLENBQUE7QUFDYixDQUFDO0FBUkQsNENBUUM7QUFFRCxTQUFTLGtCQUFrQixDQUFDLFNBQW9CO0lBQzlDLFdBQVc7SUFDWCx1R0FBdUc7SUFDdkcsV0FBVyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQ3RCLElB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