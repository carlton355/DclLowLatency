var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
import { newId } from './helpers';
import { EventConstructor } from './EventManager';
import { UIValue } from './UIValue';
var componentSymbol = '__name__symbol_';
var componentClassIdSymbol = '__classId__symbol_';
var componentIdSymbol = '__component__id_';
/**
 * @public
 */
var DisposableComponentCreated = /** @class */ (function () {
    function DisposableComponentCreated(componentId, componentName, classId) {
        this.componentId = componentId;
        this.componentName = componentName;
        this.classId = classId;
        // stub
    }
    DisposableComponentCreated = __decorate([
        EventConstructor(),
        __metadata("design:paramtypes", [String, String, Number])
    ], DisposableComponentCreated);
    return DisposableComponentCreated;
}());
export { DisposableComponentCreated };
/**
 * @public
 */
var DisposableComponentRemoved = /** @class */ (function () {
    function DisposableComponentRemoved(componentId) {
        this.componentId = componentId;
        // stub
    }
    DisposableComponentRemoved = __decorate([
        EventConstructor(),
        __metadata("design:paramtypes", [String])
    ], DisposableComponentRemoved);
    return DisposableComponentRemoved;
}());
export { DisposableComponentRemoved };
/**
 * @public
 */
var DisposableComponentUpdated = /** @class */ (function () {
    function DisposableComponentUpdated(componentId, component) {
        this.componentId = componentId;
        this.component = component;
        // stub
    }
    DisposableComponentUpdated = __decorate([
        EventConstructor(),
        __metadata("design:paramtypes", [String, Object])
    ], DisposableComponentUpdated);
    return DisposableComponentUpdated;
}());
export { DisposableComponentUpdated };
/**
 * @public
 */
export function Component(componentName, classId) {
    return function (target) {
        if (target.isComponent) {
            throw new TypeError("You cannot extend a component. Trying to extend " + target.originalClassName + " with: " + componentName);
        }
        var extendedClass = target;
        var RegisteredComponent = function RegisteredComponent() {
            // eslint-disable-next-line prefer-rest-params
            var args = Array.prototype.slice.call(arguments);
            var ret = new (extendedClass.bind.apply(extendedClass, __spreadArray([void 0], __read(args), false)))();
            Object.defineProperty(ret, componentSymbol, {
                enumerable: false,
                writable: false,
                configurable: false,
                value: componentName
            });
            if (classId !== undefined) {
                Object.defineProperty(ret, componentClassIdSymbol, {
                    enumerable: false,
                    writable: false,
                    configurable: false,
                    value: classId
                });
            }
            return ret;
        };
        if (classId !== undefined) {
            RegisteredComponent[componentClassIdSymbol] = classId;
        }
        RegisteredComponent[componentSymbol] = componentName;
        RegisteredComponent.isComponent = true;
        RegisteredComponent.originalClassName = componentName;
        RegisteredComponent.prototype = target.prototype;
        RegisteredComponent.prototype.constructor = target;
        return RegisteredComponent;
    };
}
/**
 * @public
 */
export function DisposableComponent(componentName, classId) {
    return function (target) {
        if (target.isComponent) {
            throw new TypeError("You cannot extend a component. Trying to extend " + target.originalClassName + " with: " + componentName);
        }
        if (typeof classId !== 'number' || isNaN(classId)) {
            throw new Error("classId: " + classId + " is an invalid integer");
        }
        var extendedClass = target;
        var RegisteredComponent = function RegisteredComponent() {
            if (!DisposableComponent.engine) {
                throw new Error('You need to set a DisposableComponent.engine before creating disposable components');
            }
            // eslint-disable-next-line prefer-rest-params
            var args = Array.prototype.slice.call(arguments);
            var ret = new (extendedClass.bind.apply(extendedClass, __spreadArray([void 0], __read(args), false)))();
            var id = newId('C');
            Object.defineProperty(ret, componentSymbol, {
                enumerable: false,
                writable: false,
                configurable: false,
                value: componentName
            });
            Object.defineProperty(ret, componentIdSymbol, {
                enumerable: false,
                writable: false,
                configurable: false,
                value: id
            });
            if (classId !== undefined) {
                Object.defineProperty(ret, componentClassIdSymbol, {
                    enumerable: false,
                    writable: false,
                    configurable: false,
                    value: classId
                });
            }
            if (DisposableComponent.engine) {
                DisposableComponent.engine.registerComponent(ret);
            }
            return ret;
        };
        if (classId !== undefined) {
            RegisteredComponent[componentClassIdSymbol] = classId;
        }
        RegisteredComponent[componentSymbol] = componentName;
        RegisteredComponent.isComponent = true;
        RegisteredComponent.isDisposableComponent = true;
        RegisteredComponent.originalClassName = componentName;
        RegisteredComponent.prototype = target.prototype;
        RegisteredComponent.prototype.constructor = target;
        return RegisteredComponent;
    };
}
/** @internal */
(function (DisposableComponent) {
    /** @internal */
    // eslint-disable-next-line prefer-const
    DisposableComponent.engine = null;
})(DisposableComponent || (DisposableComponent = {}));
/**
 * @public
 */
export function getComponentName(component) {
    if (!component) {
        throw new TypeError(component + ' is not a component.');
    }
    if (component[componentSymbol]) {
        return component[componentSymbol];
    }
    throw new TypeError(component + ' is not a registered component.');
}
/**
 * @public
 */
export function getComponentClassId(component) {
    if (!component) {
        throw new TypeError(component + ' is not a component.');
    }
    if (component[componentClassIdSymbol]) {
        return component[componentClassIdSymbol];
    }
    if (!component[componentSymbol]) {
        throw new TypeError(component + ' is not a registered component.');
    }
    return null;
}
/**
 * @public
 */
export function getComponentId(component) {
    if (!component) {
        throw new TypeError(component + ' is not a component.');
    }
    if (component[componentIdSymbol]) {
        return component[componentIdSymbol];
    }
    throw new TypeError(component + ' is not a registered disposable component.');
}
/**
 * @public
 */
var ObservableComponent = /** @class */ (function () {
    function ObservableComponent() {
        // @internal
        this.dirty = false;
        // @internal
        this.data = {};
        this.subscriptions = [];
    }
    ObservableComponent.component = function (target, propertyKey) {
        if (delete target[propertyKey]) {
            var componentSymbol_1 = propertyKey + '_' + Math.random();
            target[componentSymbol_1] = undefined;
            Object.defineProperty(target, componentSymbol_1, __assign(__assign({}, Object.getOwnPropertyDescriptor(target, componentSymbol_1)), { enumerable: false }));
            Object.defineProperty(target, propertyKey.toString(), {
                get: function () {
                    return this[componentSymbol_1];
                },
                set: function (value) {
                    var oldValue = this[componentSymbol_1];
                    if (value) {
                        this.data[propertyKey] = getComponentId(value);
                    }
                    else {
                        this.data[propertyKey] = null;
                    }
                    this[componentSymbol_1] = value;
                    if (value !== oldValue) {
                        this.dirty = true;
                        for (var i = 0; i < this.subscriptions.length; i++) {
                            this.subscriptions[i](propertyKey, value, oldValue);
                        }
                    }
                },
                enumerable: true
            });
        }
    };
    ObservableComponent.field = function (target, propertyKey) {
        if (delete target[propertyKey]) {
            Object.defineProperty(target, propertyKey.toString(), {
                get: function () {
                    return this.data[propertyKey];
                },
                set: function (value) {
                    var oldValue = this.data[propertyKey];
                    this.data[propertyKey] = value;
                    if (value !== oldValue) {
                        this.dirty = true;
                        for (var i = 0; i < this.subscriptions.length; i++) {
                            this.subscriptions[i](propertyKey, value, oldValue);
                        }
                    }
                },
                enumerable: true
            });
        }
    };
    ObservableComponent.uiValue = function (target, propertyKey) {
        if (delete target[propertyKey]) {
            Object.defineProperty(target, propertyKey.toString(), {
                get: function () {
                    return this.data[propertyKey].toString();
                },
                set: function (value) {
                    var oldValue = this.data[propertyKey];
                    var finalValue = new UIValue(value);
                    this.data[propertyKey] = finalValue;
                    if (finalValue !== oldValue) {
                        this.dirty = true;
                        for (var i = 0; i < this.subscriptions.length; i++) {
                            this.subscriptions[i](propertyKey, finalValue, oldValue);
                        }
                    }
                },
                enumerable: true
            });
        }
    };
    ObservableComponent.readonly = function (target, propertyKey) {
        if (delete target[propertyKey]) {
            Object.defineProperty(target, propertyKey.toString(), {
                get: function () {
                    if (propertyKey in this.data === false) {
                        throw new Error("The field " + propertyKey + " is uninitialized");
                    }
                    return this.data[propertyKey];
                },
                set: function (value) {
                    if (propertyKey in this.data) {
                        throw new Error("The field " + propertyKey + " is readonly");
                    }
                    this.data[propertyKey] = value;
                    this.dirty = true;
                },
                enumerable: true,
                configurable: false
            });
        }
    };
    ObservableComponent.prototype.onChange = function (fn) {
        this.subscriptions.push(fn);
        return this;
    };
    ObservableComponent.prototype.toJSON = function () {
        return this.data;
    };
    return ObservableComponent;
}());
export { ObservableComponent };
/**
 * @public
 */
export function isDisposableComponent(component) {
    return componentIdSymbol in component;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2Vjcy9Db21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFdBQVcsQ0FBQTtBQUNqQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUNqRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sV0FBVyxDQUFBO0FBRW5DLElBQU0sZUFBZSxHQUFHLGlCQUFpQixDQUFBO0FBQ3pDLElBQU0sc0JBQXNCLEdBQUcsb0JBQW9CLENBQUE7QUFDbkQsSUFBTSxpQkFBaUIsR0FBRyxrQkFBa0IsQ0FBQTtBQXVENUM7O0dBRUc7QUFFSDtJQUNFLG9DQUNTLFdBQW1CLEVBQ25CLGFBQXFCLEVBQ3JCLE9BQWU7UUFGZixnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQUNuQixrQkFBYSxHQUFiLGFBQWEsQ0FBUTtRQUNyQixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBRXRCLE9BQU87SUFDVCxDQUFDO0lBUFUsMEJBQTBCO1FBRHRDLGdCQUFnQixFQUFFOztPQUNOLDBCQUEwQixDQVF0QztJQUFELGlDQUFDO0NBQUEsQUFSRCxJQVFDO1NBUlksMEJBQTBCO0FBVXZDOztHQUVHO0FBRUg7SUFDRSxvQ0FBbUIsV0FBbUI7UUFBbkIsZ0JBQVcsR0FBWCxXQUFXLENBQVE7UUFDcEMsT0FBTztJQUNULENBQUM7SUFIVSwwQkFBMEI7UUFEdEMsZ0JBQWdCLEVBQUU7O09BQ04sMEJBQTBCLENBSXRDO0lBQUQsaUNBQUM7Q0FBQSxBQUpELElBSUM7U0FKWSwwQkFBMEI7QUFNdkM7O0dBRUc7QUFFSDtJQUNFLG9DQUNTLFdBQW1CLEVBQ25CLFNBQWtDO1FBRGxDLGdCQUFXLEdBQVgsV0FBVyxDQUFRO1FBQ25CLGNBQVMsR0FBVCxTQUFTLENB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LElBQUksQ0FBQyxJQUFJLENBQUE7SUFDbEIsQ0FBQztJQUNILDBCQUFDO0FBQUQsQ0FBQyxBQTVIRCxJQTRIQzs7QUFFRDs7R0FFRztBQUNILE1BQU0sVUFBVSxxQkFBcUIsQ0FBQyxTQUF3QjtJQUM1RCxPQUFPLGlCQUFpQixJQUFJLFNBQVMsQ0FBQTtBQUN2QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbmV3SWQgfSBmcm9tICcuL2hlbHBlcnMnXG5pbXBvcnQgeyBFdmVudENvbnN0cnVjdG9yIH0gZnJvbSAnLi9FdmVudE1hbmFnZXInXG5pbXBvcnQgeyBVSVZhbHVlIH0gZnJvbSAnLi9VSVZhbHVlJ1xuXG5jb25zdCBjb21wb25lbnRTeW1ib2wgPSAnX19uYW1lX19zeW1ib2xfJ1xuY29uc3QgY29tcG9uZW50Q2xhc3NJZFN5bWJvbCA9ICdfX2NsYXNzSWRfX3N5bWJvbF8nXG5jb25zdCBjb21wb25lbnRJZFN5bWJvbCA9ICdfX2NvbXBvbmVudF9faWRfJ1xuXG4vKipcbiAqIEBwdWJsaWNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDb21wb25lbnRMaWtlIHtcbiAgLy8gQGludGVybmFsXG4gIFtjb21wb25lbnRTeW1ib2xdPzogc3RyaW5nXG4gIC8vIEBpbnRlcm5hbFxuICBbY29tcG9uZW50Q2xhc3NJZFN5bWJvbF0/OiBudW1iZXJcblxuICAvLyBAaW50ZXJuYWxcbiAgYWRkZWRUb0VudGl0eT8oZW50aXR5OiBhbnkpOiB2b2lkXG4gIC8vIEBpbnRlcm5hbFxuICByZW1vdmVkRnJvbUVudGl0eT8oZW50aXR5OiBhbnkpOiB2b2lkXG59XG5cbi8qKlxuICogQHB1YmxpY1xuICovXG5leHBvcnQgaW50ZXJmYWNlIERpc3Bvc2FibGVDb21wb25lbnRMaWtlIGV4dGVuZHMgQ29tcG9uZW50TGlrZSB7XG4gIC8vIEBpbnRlcm5hbFxuICBbY29tcG9uZW50SWRTeW1ib2xdPzogc3RyaW5nXG4gIG9uRGlzcG9zZT8oKTogdm9pZFxufVxuXG4vKipcbiAqIEBwdWJsaWNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDb21wb25lbnRDb25zdHJ1Y3RvcjxUIGV4dGVuZHMgQ29tcG9uZW50TGlrZT4ge1xuICAvLyBAaW50ZXJuYWxcbiAgW2NvbXBvbmVudFN5bWJvbF0/OiBzdHJpbmdcbiAgLy8gQGludGVybmFsXG4gIFtjb21wb25lbnRDbGFzc0lkU3ltYm9sXT86IG51bWJlclxuICBpc0NvbXBvbmVudD86IGJvb2xlYW5cbiAgb3JpZ2luYWxDbGFzc05hbWU/OiBzdHJpbmdcbiAgbmV3ICguLi5hcmdzOiBhbnlbXSk6IFRcbn1cblxuLyoqXG4gKiBAcHVibGljXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRGlzcG9zYWJsZUNvbXBvbmVudENvbnN0cnVjdG9yPFxuICBUIGV4dGVuZHMgRGlzcG9zYWJsZUNvbXBvbmVudExpa2Vcbj4ge1xuICAvLyBAaW50ZXJuYWxcbiAgW2NvbXBvbmVudFN5bWJvbF0/OiBzdHJpbmdcbiAgLy8gQGludGVybmFsXG4gIFtjb21wb25lbnRDbGFzc0lkU3ltYm9sXT86IG51bWJlclxuICBpc0NvbXBvbmVudD86IGJvb2xlYW5cbiAgaXNEaXNwb3NhYmxlQ29tcG9uZW50PzogdHJ1ZVxuICBvcmlnaW5hbENsYXNzTmFtZT86IHN0cmluZ1xuICBuZXcgKC4uLmFyZ3M6IGFueVtdKTogVFxufVxuXG4vKipcbiAqIEBwdWJsaWNcbiAqL1xuQEV2ZW50Q29uc3RydWN0b3IoKVxuZXhwb3J0IGNsYXNzIERpc3Bvc2FibGVDb21wb25lbnRDcmVhdGVkIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGNvbXBvbmVudElkOiBzdHJpbmcsXG4gICAgcHVibGljIGNvbXBvbmVudE5hbWU6IHN0cmluZyxcbiAgICBwdWJsaWMgY2xhc3NJZDogbnVtYmVyXG4gICkge1xuICAgIC8vIHN0dWJcbiAgfVxufVxuXG4vKipcbiAqIEBwdWJsaWNcbiAqL1xuQEV2ZW50Q29uc3RydWN0b3IoKVxuZXhwb3J0IGNsYXNzIERpc3Bvc2FibGVDb21wb25lbnRSZW1vdmVkIHtcbiAgY29uc3RydWN0b3IocHVibGljIGNvbXBvbmVudElkOiBzdHJpbmcpIHtcbiAgICAvLyBzdHViXG4gIH1cbn1cblxuLyoqXG4gKiBAcHVibGljXG4gKi9cbkBFdmVudENvbnN0cnVjdG9yKClcbmV4cG9ydCBjbGFzcyBEaXNwb3NhYmxlQ29tcG9uZW50VXBkYXRlZCB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBjb21wb25lbnRJZDogc3RyaW5nLFxuICAgIHB1YmxpYyBjb21wb25lbnQ6IERpc3Bvc2FibGVDb21wb25lbnRMaWtlXG4gICkge1xuICAgIC8vIHN0dWJcbiAgfVxufVxuXG4vKipcbiAqIEBwdWJsaWNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIENvbXBvbmVudChjb21wb25lbnROYW1lOiBzdHJpbmcsIGNsYXNzSWQ/OiBudW1iZXIpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIDxURnVuY3Rpb24gZXh0ZW5kcyBDb21wb25lbnRDb25zdHJ1Y3Rvcjxhbnk+PihcbiAgICB0YXJnZXQ6IFRGdW5jdGlvblxuICApOiBURnVuY3Rpb24gfCB2b2lkIHtcbiAgICBpZiAodGFyZ2V0LmlzQ29tcG9uZW50KSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICBgWW91IGNhbm5vdCBleHRlbmQgYSBjb21wb25lbnQuIFRyeWluZyB0byBleHRlbmQgJHt0YXJnZXQub3JpZ2luYWxDbGFzc05hbWV9IHdpdGg6ICR7Y29tcG9uZW50TmFtZX1gXG4gICAgICApXG4gICAgfVxuXG4gICAgY29uc3QgZXh0ZW5kZWRDbGFzcyA9IHRhcmdldCBhcyBhbnlcblxuICAgIGNvbnN0IFJlZ2lzdGVyZWRDb21wb25lbnQ6IGFueSA9IGZ1bmN0aW9uIFJlZ2lzdGVyZWRDb21wb25lbnQoKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLXJlc3QtcGFyYW1zXG4gICAgICBjb25zdCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKVxuICAgICAgY29uc3QgcmV0ID0gbmV3IGV4dGVuZGVkQ2xhc3MoLi4uYXJncylcblxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHJldCwgY29tcG9uZW50U3ltYm9sLCB7XG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsXG4gICAgICAgIHZhbHVlOiBjb21wb25lbnROYW1lXG4gICAgICB9KVxuXG4gICAgICBpZiAoY2xhc3NJZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShyZXQsIGNvbXBvbmVudENsYXNzSWRTeW1ib2wsIHtcbiAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSxcbiAgICAgICAgICB2YWx1ZTogY2xhc3NJZFxuICAgICAgICB9KVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmV0XG4gICAgfVxuXG4gICAgaWYgKGNsYXNzSWQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgUmVnaXN0ZXJlZENvbXBvbmVudFtjb21wb25lbnRDbGFzc0lkU3ltYm9sXSA9IGNsYXNzSWRcbiAgICB9XG5cbiAgICBSZWdpc3RlcmVkQ29tcG9uZW50W2NvbXBvbmVudFN5bWJvbF0gPSBjb21wb25lbnROYW1lXG4gICAgUmVnaXN0ZXJlZENvbXBvbmVudC5pc0NvbXBvbmVudCA9IHRydWVcbiAgICBSZWdpc3RlcmVkQ29tcG9uZW50Lm9yaWdpbmFsQ2xhc3NOYW1lID0gY29tcG9uZW50TmFtZVxuXG4gICAgUmVnaXN0ZXJlZENvbXBvbmVudC5wcm90b3R5cGUgPSB0YXJnZXQucHJvdG90eXBlXG4gICAgUmVnaXN0ZXJlZENvbXBvbmVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSB0YXJnZXRcblxuICAgIHJldHVybiBSZWdpc3RlcmVkQ29tcG9uZW50IGFzIFRGdW5jdGlvblxuICB9XG59XG5cbi8qKlxuICogQHB1YmxpY1xuICovXG5cbmV4cG9ydCBmdW5jdGlvbiBEaXNwb3NhYmxlQ29tcG9uZW50KGNvbXBvbmVudE5hbWU6IHN0cmluZywgY2xhc3NJZDogbnVtYmVyKSB7XG4gIHJldHVybiBmdW5jdGlvbiA8VEZ1bmN0aW9uIGV4dGVuZHMgRGlzcG9zYWJsZUNvbXBvbmVudENvbnN0cnVjdG9yPGFueT4+KFxuICAgIHRhcmdldDogVEZ1bmN0aW9uXG4gICk6IFRGdW5jdGlvbiB8IHZvaWQge1xuICAgIGlmICh0YXJnZXQuaXNDb21wb25lbnQpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICAgIGBZb3UgY2Fubm90IGV4dGVuZCBhIGNvbXBvbmVudC4gVHJ5aW5nIHRvIGV4dGVuZCAke3RhcmdldC5vcmlnaW5hbENsYXNzTmFtZX0gd2l0aDogJHtjb21wb25lbnROYW1lfWBcbiAgICAgIClcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIChjbGFzc0lkIGFzIGFueSkgIT09ICdudW1iZXInIHx8IGlzTmFOKGNsYXNzSWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGNsYXNzSWQ6ICR7Y2xhc3NJZH0gaXMgYW4gaW52YWxpZCBpbnRlZ2VyYClcbiAgICB9XG5cbiAgICBjb25zdCBleHRlbmRlZENsYXNzID0gdGFyZ2V0XG5cbiAgICBjb25zdCBSZWdpc3RlcmVkQ29tcG9uZW50OiBhbnkgPSBmdW5jdGlvbiBSZWdpc3RlcmVkQ29tcG9uZW50KCkge1xuICAgICAgaWYgKCFEaXNwb3NhYmxlQ29tcG9uZW50LmVuZ2luZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ1lvdSBuZWVkIHRvIHNldCBhIERpc3Bvc2FibGVDb21wb25lbnQuZW5naW5lIGJlZm9yZSBjcmVhdGluZyBkaXNwb3NhYmxlIGNvbXBvbmVudHMnXG4gICAgICAgIClcbiAgICAgIH1cblxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1yZXN0LXBhcmFtc1xuICAgICAgY29uc3QgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cylcbiAgICAgIGNvbnN0IHJldCA9IG5ldyBleHRlbmRlZENsYXNzKC4uLihhcmdzIGFzIGFueSkpXG4gICAgICBjb25zdCBpZCA9IG5ld0lkKCdDJylcblxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHJldCwgY29tcG9uZW50U3ltYm9sLCB7XG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsXG4gICAgICAgIHZhbHVlOiBjb21wb25lbnROYW1lXG4gICAgICB9KVxuXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocmV0LCBjb21wb25lbnRJZFN5bWJvbCwge1xuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgd3JpdGFibGU6IGZhbHNlLFxuICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLFxuICAgICAgICB2YWx1ZTogaWRcbiAgICAgIH0pXG5cbiAgICAgIGlmICgoY2xhc3NJZCBhcyBhbnkpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHJldCwgY29tcG9uZW50Q2xhc3NJZFN5bWJvbCwge1xuICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSxcbiAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLFxuICAgICAgICAgIHZhbHVlOiBjbGFzc0lkXG4gICAgICAgIH0pXG4gICAgICB9XG5cbiAgICAgIGlmIChEaXNwb3NhYmxlQ29tcG9uZW50LmVuZ2luZSkge1xuICAgICAgICBEaXNwb3NhYmxlQ29tcG9uZW50LmVuZ2luZS5yZWdpc3RlckNvbXBvbmVudChyZXQpXG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXRcbiAgICB9XG5cbiAgICBpZiAoKGNsYXNzSWQgYXMgYW55KSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBSZWdpc3RlcmVkQ29tcG9uZW50W2NvbXBvbmVudENsYXNzSWRTeW1ib2xdID0gY2xhc3NJZFxuICAgIH1cblxuICAgIFJlZ2lzdGVyZWRDb21wb25lbnRbY29tcG9uZW50U3ltYm9sXSA9IGNvbXBvbmVudE5hbWVcbiAgICBSZWdpc3RlcmVkQ29tcG9uZW50LmlzQ29tcG9uZW50ID0gdHJ1ZVxuICAgIFJlZ2lzdGVyZWRDb21wb25lbnQuaXNEaXNwb3NhYmxlQ29tcG9uZW50ID0gdHJ1ZVxuICAgIFJlZ2lzdGVyZWRDb21wb25lbnQub3JpZ2luYWxDbGFzc05hbWUgPSBjb21wb25lbnROYW1lXG5cbiAgICBSZWdpc3RlcmVkQ29tcG9uZW50LnByb3RvdHlwZSA9IHRhcmdldC5wcm90b3R5cGVcbiAgICBSZWdpc3RlcmVkQ29tcG9uZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHRhcmdldFxuXG4gICAgcmV0dXJuIFJlZ2lzdGVyZWRDb21wb25lbnQgYXMgVEZ1bmN0aW9uXG4gIH1cbn1cblxuLyoqIEBpbnRlcm5hbCAqL1xuZXhwb3J0IG5hbWVzcGFjZSBEaXNwb3NhYmxlQ29tcG9uZW50IHtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLWNvbnN0XG4gIGV4cG9ydCBsZXQgZW5naW5lOiBhbnkgPSBudWxsXG59XG5cbi8qKlxuICogQHB1YmxpY1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZTxUIGV4dGVuZHMgUmVjb3JkPGFueSwgYW55PiA9IGFueT4oXG4gIGNvbXBvbmVudDogVCB8IENvbXBvbmVudENvbnN0cnVjdG9yPFQ+XG4pOiBzdHJpbmcge1xuICBpZiAoIWNvbXBvbmVudCkge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoY29tcG9uZW50ICsgJyBpcyBub3QgYSBjb21wb25lbnQuJylcbiAgfVxuICBpZiAoY29tcG9uZW50W2NvbXBvbmVudFN5bWJvbF0pIHtcbiAgICByZXR1cm4gY29tcG9uZW50W2NvbXBvbmVudFN5bWJvbF0gYXMgc3RyaW5nXG4gIH1cbiAgdGhyb3cgbmV3IFR5cGVFcnJvcihjb21wb25lbnQgKyAnIGlzIG5vdCBhIHJlZ2lzdGVyZWQgY29tcG9uZW50LicpXG59XG5cbi8qKlxuICogQHB1YmxpY1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q29tcG9uZW50Q2xhc3NJZDxUIGV4dGVuZHMgUmVjb3JkPGFueSwgYW55PiA9IGFueT4oXG4gIGNvbXBvbmVudDogVCB8IENvbXBvbmVudENvbnN0cnVjdG9yPFQ+XG4pOiBudW1iZXIgfCBudWxsIHtcbiAgaWYgKCFjb21wb25lbnQpIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGNvbXBvbmVudCArICcgaXMgbm90IGEgY29tcG9uZW50LicpXG4gIH1cbiAgaWYgKGNvbXBvbmVudFtjb21wb25lbnRDbGFzc0lkU3ltYm9sXSkge1xuICAgIHJldHVybiBjb21wb25lbnRbY29tcG9uZW50Q2xhc3NJZFN5bWJvbF0gYXMgbnVtYmVyXG4gIH1cbiAgaWYgKCFjb21wb25lbnRbY29tcG9uZW50U3ltYm9sXSkge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoY29tcG9uZW50ICsgJyBpcyBub3QgYSByZWdpc3RlcmVkIGNvbXBvbmVudC4nKVxuICB9XG5cbiAgcmV0dXJuIG51bGxcbn1cblxuLyoqXG4gKiBAcHVibGljXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb21wb25lbnRJZDxUIGV4dGVuZHMgRGlzcG9zYWJsZUNvbXBvbmVudExpa2U+KFxuICBjb21wb25lbnQ6IFRcbik6IHN0cmluZyB7XG4gIGlmICghY29tcG9uZW50KSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihjb21wb25lbnQgKyAnIGlzIG5vdCBhIGNvbXBvbmVudC4nKVxuICB9XG4gIGlmIChjb21wb25lbnRbY29tcG9uZW50SWRTeW1ib2xdKSB7XG4gICAgcmV0dXJuIGNvbXBvbmVudFtjb21wb25lbnRJZFN5bWJvbF0gYXMgYW55IGFzIHN0cmluZ1xuICB9XG4gIHRocm93IG5ldyBUeXBlRXJyb3IoY29tcG9uZW50ICsgJyBpcyBub3QgYSByZWdpc3RlcmVkIGRpc3Bvc2FibGUgY29tcG9uZW50LicpXG59XG5cbi8qKiBAcHVibGljICovXG5leHBvcnQgdHlwZSBPYnNlcnZhYmxlQ29tcG9uZW50U3Vic2NyaXB0aW9uID0gKFxuICBrZXk6IHN0cmluZyxcbiAgbmV3VmFsOiBhbnksXG4gIG9sZFZhbDogYW55XG4pID0+IHZvaWRcblxuLyoqXG4gKiBAcHVibGljXG4gKi9cbmV4cG9ydCBjbGFzcyBPYnNlcnZhYmxlQ29tcG9uZW50IHtcbiAgLy8gQGludGVybmFsXG4gIGRpcnR5OiBib29sZWFuID0gZmFsc2VcbiAgLy8gQGludGVybmFsXG4gIGRhdGE6IGFueSA9IHt9XG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uczogQXJyYXk8T2JzZXJ2YWJsZUNvbXBvbmVudFN1YnNjcmlwdGlvbj4gPSBbXVxuXG4gIHN0YXRpYyBjb21wb25lbnQodGFyZ2V0OiBPYnNlcnZhYmxlQ29tcG9uZW50LCBwcm9wZXJ0eUtleTogc3RyaW5nKSB7XG4gICAgaWYgKGRlbGV0ZSAodGFyZ2V0IGFzIGFueSlbcHJvcGVydHlLZXldKSB7XG4gICAgICBjb25zdCBjb21wb25lbnRTeW1ib2wgPSBwcm9wZXJ0eUtleSArICdfJyArIE1hdGgucmFuZG9tKClcbiAgICAgIDsodGFyZ2V0IGFzIGFueSlbY29tcG9uZW50U3ltYm9sXSA9IHVuZGVmaW5lZFxuXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBjb21wb25lbnRTeW1ib2wsIHtcbiAgICAgICAgLi4uT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGNvbXBvbmVudFN5bWJvbCksXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlXG4gICAgICB9KVxuXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBwcm9wZXJ0eUtleS50b1N0cmluZygpLCB7XG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHJldHVybiB0aGlzW2NvbXBvbmVudFN5bWJvbF1cbiAgICAgICAgfSxcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXNbY29tcG9uZW50U3ltYm9sXVxuXG4gICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLmRhdGFbcHJvcGVydHlLZXldID0gZ2V0Q29tcG9uZW50SWQodmFsdWUpXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YVtwcm9wZXJ0eUtleV0gPSBudWxsXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdGhpc1tjb21wb25lbnRTeW1ib2xdID0gdmFsdWVcblxuICAgICAgICAgIGlmICh2YWx1ZSAhPT0gb2xkVmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMuZGlydHkgPSB0cnVlXG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zdWJzY3JpcHRpb25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uc1tpXShwcm9wZXJ0eUtleSwgdmFsdWUsIG9sZFZhbHVlKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZVxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgZmllbGQodGFyZ2V0OiBPYnNlcnZhYmxlQ29tcG9uZW50LCBwcm9wZXJ0eUtleTogc3RyaW5nKSB7XG4gICAgaWYgKGRlbGV0ZSAodGFyZ2V0IGFzIGFueSlbcHJvcGVydHlLZXldKSB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBwcm9wZXJ0eUtleS50b1N0cmluZygpLCB7XG4gICAgICAgIGdldDogZnVuY3Rpb24gKHRoaXM6IE9ic2VydmFibGVDb21wb25lbnQpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhW3Byb3BlcnR5S2V5XVxuICAgICAgICB9LFxuICAgICAgICBzZXQ6IGZ1bmN0aW9uICh0aGlzOiBPYnNlcnZhYmxlQ29tcG9uZW50LCB2YWx1ZSkge1xuICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpcy5kYXRhW3Byb3BlcnR5S2V5XVxuICAgICAgICAgIHRoaXMuZGF0YVtwcm9wZXJ0eUtleV0gPSB2YWx1ZVxuXG4gICAgICAgICAgaWYgKHZhbHVlICE9PSBvbGRWYWx1ZSkge1xuICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IHRydWVcblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnN1YnNjcmlwdGlvbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zW2ldKHByb3BlcnR5S2V5LCB2YWx1ZSwgb2xkVmFsdWUpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBlbnVtZXJhYmxlOiB0cnVlXG4gICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyB1aVZhbHVlKHRhcmdldDogT2JzZXJ2YWJsZUNvbXBvbmVudCwgcHJvcGVydHlLZXk6IHN0cmluZykge1xuICAgIGlmIChkZWxldGUgKHRhcmdldCBhcyBhbnkpW3Byb3BlcnR5S2V5XSkge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgcHJvcGVydHlLZXkudG9TdHJpbmcoKSwge1xuICAgICAgICBnZXQ6IGZ1bmN0aW9uICh0aGlzOiBPYnNlcnZhYmxlQ29tcG9uZW50KTogc3RyaW5nIHwgbnVtYmVyIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhW3Byb3BlcnR5S2V5XS50b1N0cmluZygpXG4gICAgICAgIH0sXG4gICAgICAgIHNldDogZnVuY3Rpb24gKHRoaXM6IE9ic2VydmFibGVDb21wb25lbnQsIHZhbHVlOiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXMuZGF0YVtwcm9wZXJ0eUtleV1cblxuICAgICAgICAgIGNvbnN0IGZpbmFsVmFsdWUgPSBuZXcgVUlWYWx1ZSh2YWx1ZSlcblxuICAgICAgICAgIHRoaXMuZGF0YVtwcm9wZXJ0eUtleV0gPSBmaW5hbFZhbHVlXG5cbiAgICAgICAgICBpZiAoZmluYWxWYWx1ZSAhPT0gb2xkVmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMuZGlydHkgPSB0cnVlXG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zdWJzY3JpcHRpb25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uc1tpXShwcm9wZXJ0eUtleSwgZmluYWxWYWx1ZSwgb2xkVmFsdWUpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBlbnVtZXJhYmxlOiB0cnVlXG4gICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyByZWFkb25seSh0YXJnZXQ6IE9ic2VydmFibGVDb21wb25lbnQsIHByb3BlcnR5S2V5OiBzdHJpbmcpIHtcbiAgICBpZiAoZGVsZXRlICh0YXJnZXQgYXMgYW55KVtwcm9wZXJ0eUtleV0pIHtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIHByb3BlcnR5S2V5LnRvU3RyaW5nKCksIHtcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAodGhpczogT2JzZXJ2YWJsZUNvbXBvbmVudCkge1xuICAgICAgICAgIGlmIChwcm9wZXJ0eUtleSBpbiB0aGlzLmRhdGEgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBmaWVsZCAke3Byb3BlcnR5S2V5fSBpcyB1bmluaXRpYWxpemVkYClcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YVtwcm9wZXJ0eUtleV1cbiAgICAgICAgfSxcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAodGhpczogT2JzZXJ2YWJsZUNvbXBvbmVudCwgdmFsdWUpIHtcbiAgICAgICAgICBpZiAocHJvcGVydHlLZXkgaW4gdGhpcy5kYXRhKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBmaWVsZCAke3Byb3BlcnR5S2V5fSBpcyByZWFkb25seWApXG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuZGF0YVtwcm9wZXJ0eUtleV0gPSB2YWx1ZVxuICAgICAgICAgIHRoaXMuZGlydHkgPSB0cnVlXG4gICAgICAgIH0sXG4gICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2VcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgb25DaGFuZ2UoZm46IE9ic2VydmFibGVDb21wb25lbnRTdWJzY3JpcHRpb24pIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaChmbilcbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgdG9KU09OKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGFcbiAgfVxufVxuXG4vKipcbiAqIEBwdWJsaWNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGlzRGlzcG9zYWJsZUNvbXBvbmVudChjb21wb25lbnQ6IENvbXBvbmVudExpa2UpIHtcbiAgcmV0dXJuIGNvbXBvbmVudElkU3ltYm9sIGluIGNvbXBvbmVudFxufVxuIl19