var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
import { ComponentAdded, ComponentRemoved } from './IEntity';
import { getComponentName, getComponentId, DisposableComponentUpdated, DisposableComponentCreated, DisposableComponentRemoved, getComponentClassId } from './Component';
import { EventManager } from './EventManager';
import { ComponentGroup } from './ComponentGroup';
import { log, error } from './helpers';
import { Entity } from './Entity';
/**
 * @public
 */
var Engine = /** @class */ (function () {
    function Engine(rootEntity) {
        this.eventManager = new EventManager();
        // @internal
        this.systems = [];
        // @internal
        this.entityLists = {};
        // @internal
        this.addedSystems = [];
        this._entities = {};
        this._disposableComponents = {};
        this._componentGroups = {};
        // systems that doesn't require any component or handle their own logic
        this.simpleSystems = [];
        this.eventManager.addListener(ComponentAdded, this, this.componentAddedHandler);
        this.eventManager.addListener(ComponentRemoved, this, this.componentRemovedHandler);
        this.rootEntity = rootEntity;
        this.firstPersonCameraEntity = new Entity();
        this.firstPersonCameraEntity.uuid =
            'FirstPersonCameraEntityReference';
        this.addEntity(this.firstPersonCameraEntity);
        this.avatarEntity = new Entity();
        this.avatarEntity.uuid = 'AvatarEntityReference';
        this.addEntity(this.avatarEntity);
    }
    Object.defineProperty(Engine.prototype, "entities", {
        get: function () {
            return this._entities;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(Engine.prototype, "disposableComponents", {
        get: function () {
            return this._disposableComponents;
        },
        enumerable: false,
        configurable: true
    });
    Engine.prototype.addEntity = function (entity) {
        var parent = entity.getParent();
        if (entity.isAddedToEngine()) {
            return entity;
        }
        entity.eventManager = this.eventManager;
        entity.engine = this;
        this._entities[entity.uuid] = entity;
        this.checkRequirementsAndAdd(entity);
        if (!parent) {
            entity.setParent(this.rootEntity);
        }
        else {
            if (!parent.isAddedToEngine() && parent !== this.rootEntity) {
                log('Engine: warning, added an entity with a parent not present in the engine. Parent id: ' +
                    parent.uuid);
            }
        }
        entity.alive = true;
        for (var i in entity.children) {
            var child = entity.children[i];
            if (child) {
                if (!child.isAddedToEngine()) {
                    this.addEntity(child);
                }
            }
        }
        return entity;
    };
    Engine.prototype.removeEntity = function (entity) {
        var id = entity.uuid;
        if (entity.isAddedToEngine()) {
            for (var componentName in entity.components) {
                var componentGroups = this._componentGroups[componentName];
                if (componentGroups) {
                    for (var groupIndex in componentGroups) {
                        componentGroups[groupIndex].removeEntity(entity);
                    }
                }
                delete this.entityLists[componentName][id];
            }
            for (var i = 0; i < this.simpleSystems.length; i++) {
                var system = this.simpleSystems[i];
                if (system.onRemoveEntity) {
                    system.onRemoveEntity(entity);
                }
            }
            for (var i in entity.children) {
                var child = entity.children[i];
                if (child) {
                    this.removeEntity(child);
                }
            }
            entity.alive = false;
            entity.eventManager = null;
            delete this._entities[id];
            return true;
        }
        else {
            log('Engine: Trying to remove non existent entity from engine.');
            if (!entity.isAddedToEngine()) {
                log("Engine: Entity \"" + entity.uuid + "\" has not been added to any engine yet.");
            }
            else {
                log('Engine: Entity id: ' + id);
            }
            log("Engine: Entity's components:");
            for (var componentName in entity.components) {
                log(componentName);
            }
            return false;
        }
    };
    Engine.prototype.addSystem = function (system, priority) {
        if (priority === void 0) { priority = 0; }
        if (this.addedSystems.indexOf(system) !== -1) {
            log('Engine: Trying to add a system that is already added. Aborting');
            return system;
        }
        if (this.systems.length > 0) {
            for (var i = 0; i < this.systems.length; i++) {
                var entry = this.systems[i];
                var isLast = i === this.systems.length - 1;
                if (entry.priority > priority) {
                    this.addedSystems.push(system);
                    this.systems.splice(i, 0, { system: system, priority: priority });
                    break;
                }
                else if (isLast) {
                    this.addedSystems.push(system);
                    this.systems.splice(i + 1, 0, { system: system, priority: priority });
                    break;
                }
            }
        }
        else {
            this.addedSystems.push(system);
            this.systems.splice(1, 0, { system: system, priority: priority });
        }
        this.registerSystem(system);
        return system;
    };
    Engine.prototype.removeSystem = function (system) {
        var idx = this.addedSystems.indexOf(system);
        if (idx !== -1) {
            system.active = false;
            if (system.deactivate) {
                system.deactivate();
            }
            this.addedSystems.splice(idx, 1);
            for (var i = 0; i < this.systems.length; i++) {
                var sys = this.systems[i].system;
                if (sys === system) {
                    this.systems.splice(i, 1);
                }
            }
            return true;
        }
        return false;
    };
    Engine.prototype.update = function (dt) {
        for (var i in this.systems) {
            var system = this.systems[i].system;
            if (system.active && system.update) {
                try {
                    system.update(dt);
                }
                catch (e) {
                    // TODO: e may not be an Error
                    error(e);
                }
            }
        }
        return this;
    };
    Engine.prototype.getEntitiesWithComponent = function (component) {
        var componentName = typeof component === 'string' ? component : getComponentName(component);
        if (componentName in this.entityLists) {
            return this.entityLists[componentName];
        }
        else {
            return (this.entityLists[componentName] = {});
        }
    };
    Engine.prototype.registerComponent = function (component) {
        var id = getComponentId(component);
        var name = getComponentName(component);
        var classId = getComponentClassId(component);
        this._disposableComponents[id] = component;
        if (classId !== null) {
            this.eventManager.fireEvent(new DisposableComponentCreated(id, name, classId));
            this.eventManager.fireEvent(new DisposableComponentUpdated(id, component));
        }
    };
    Engine.prototype.disposeComponent = function (component) {
        var id = getComponentId(component);
        if (delete this._disposableComponents[id]) {
            this.eventManager.fireEvent(new DisposableComponentRemoved(id));
            if (component.onDispose) {
                component.onDispose();
            }
            return true;
        }
        return false;
    };
    Engine.prototype.updateComponent = function (component) {
        this.eventManager.fireEvent(new DisposableComponentUpdated(getComponentId(component), component));
    };
    Engine.prototype.getComponentGroup = function () {
        var requires = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            requires[_i] = arguments[_i];
        }
        var componentGroup = undefined;
        // Return an already created component-group if it already exists
        if (requires.length > 0) {
            // 1. get component groups for first require
            var componentGroups = this._componentGroups[getComponentName(requires[0])];
            if (componentGroups) {
                var components = requires.slice();
                // 2. search for a component group that has all the same requirements
                for (var i = 0; i < componentGroups.length; i++) {
                    var traversedComponentGroup = componentGroups[i];
                    if (components.length === traversedComponentGroup.requires.length) {
                        for (var j = 0; j < components.length; j++) {
                            if (traversedComponentGroup.requires.indexOf(components[j]) === -1)
                                break;
                            if (j === components.length - 1) {
                                componentGroup = traversedComponentGroup;
                            }
                        }
                        if (componentGroup)
                            break;
                    }
                }
            }
        }
        if (componentGroup) {
            // 3. Found an existent component group with the exact same requirements
            return componentGroup;
        }
        // Otherwise create and store it
        componentGroup = new (ComponentGroup.bind.apply(ComponentGroup, __spreadArray([void 0], __read(requires), false)))();
        componentGroup.active = true;
        var requiresNames = componentGroup.requiresNames;
        for (var i = 0; i < requiresNames.length; i++) {
            var componentName = requiresNames[i];
            var componentGroups = this._componentGroups[componentName];
            if (!componentGroups) {
                this._componentGroups[componentName] = componentGroups = [];
            }
            if (componentGroups.indexOf(componentGroup) === -1) {
                componentGroups.push(componentGroup);
            }
        }
        for (var entityId in this._entities) {
            this.checkRequirements(this._entities[entityId], componentGroup);
        }
        return componentGroup;
    };
    Engine.prototype.removeComponentGroup = function (componentGroup) {
        if (componentGroup.active) {
            componentGroup.active = false;
            var requiresNames = componentGroup.requiresNames;
            for (var i = 0; i < requiresNames.length; i++) {
                var componentName = requiresNames[i];
                var componentGroups = this._componentGroups[componentName];
                if (componentGroups) {
                    var idx = componentGroups.indexOf(componentGroup);
                    if (idx !== -1) {
                        componentGroups.splice(idx, 1);
                    }
                }
            }
            return true;
        }
        return false;
    };
    Engine.prototype.registerSystem = function (system) {
        system.active = true;
        if (system.activate) {
            system.activate(this);
        }
        this.simpleSystems.push(system);
    };
    Engine.prototype.checkRequirementsAndAdd = function (entity) {
        if (!entity.isAddedToEngine())
            return;
        for (var componentName in entity.components) {
            if (!(componentName in this.entityLists)) {
                this.entityLists[componentName] = {};
            }
            this.entityLists[componentName][entity.uuid] = entity;
            var componentGroups = this._componentGroups[componentName];
            if (componentGroups) {
                for (var systemIndex in componentGroups) {
                    this.checkRequirements(entity, componentGroups[systemIndex]);
                }
            }
        }
        for (var i = 0; i < this.simpleSystems.length; i++) {
            var system = this.simpleSystems[i];
            if (system.onAddEntity) {
                system.onAddEntity(entity);
            }
        }
    };
    Engine.prototype.checkRequirements = function (entity, system) {
        if (system.meetsRequirements(entity)) {
            if (!system.hasEntity(entity)) {
                system.addEntity(entity);
            }
        }
        else {
            if (system.hasEntity(entity)) {
                system.removeEntity(entity);
            }
        }
    };
    Engine.prototype.componentAddedHandler = function (event) {
        var _a;
        var entity = event.entity, componentName = event.componentName;
        if (!entity.isAddedToEngine())
            return;
        if (!this.entityLists[componentName]) {
            this.entityLists[componentName] = (_a = {}, _a[entity.uuid] = entity, _a);
        }
        else {
            this.entityLists[componentName][entity.uuid] = entity;
        }
        var componentGroups = this._componentGroups[componentName];
        if (componentGroups) {
            for (var i in componentGroups) {
                this.checkRequirements(entity, componentGroups[i]);
            }
        }
    };
    Engine.prototype.componentRemovedHandler = function (event) {
        // In case a single component gets removed from an entity, we inform
        // all systems that this entity lost this specific component.
        var entity = event.entity, componentName = event.componentName;
        if (!entity.isAddedToEngine())
            return;
        delete this.entityLists[componentName][entity.uuid];
        var componentGroups = this._componentGroups[componentName];
        if (componentGroups) {
            for (var i in componentGroups) {
                this.checkRequirements(entity, componentGroups[i]);
            }
        }
    };
    return Engine;
}());
export { Engine };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW5naW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2Vjcy9FbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLE9BQU8sRUFJTCxjQUFjLEVBQ2QsZ0JBQWdCLEVBQ2pCLE1BQU0sV0FBVyxDQUFBO0FBRWxCLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsY0FBYyxFQUNkLDBCQUEwQixFQUcxQiwwQkFBMEIsRUFDMUIsMEJBQTBCLEVBQzFCLG1CQUFtQixFQUNwQixNQUFNLGFBQWEsQ0FBQTtBQUNwQixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUFDN0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBRWpELE9BQU8sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sV0FBVyxDQUFBO0FBQ3RDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUE7QUFPakM7O0dBRUc7QUFDSDtJQW1DRSxnQkFBWSxVQUFtQjtRQWxDdEIsaUJBQVksR0FBaUIsSUFBSSxZQUFZLEVBQUUsQ0FBQTtRQUt4RCxZQUFZO1FBQ0gsWUFBTyxHQUFrQixFQUFFLENBQUE7UUFFcEMsWUFBWTtRQUNILGdCQUFXLEdBQTRDLEVBQUUsQ0FBQTtRQUVsRSxZQUFZO1FBQ0gsaUJBQVksR0FBYyxFQUFFLENBQUE7UUFFcEIsY0FBUyxHQUE0QixFQUFFLENBQUE7UUFDdkMsMEJBQXFCLEdBR2xDLEVBQUUsQ0FBQTtRQUNXLHFCQUFnQixHQUFxQyxFQUFFLENBQUE7UUFFeEUsdUVBQXVFO1FBQ3RELGtCQUFhLEdBQWMsRUFBRSxDQUFBO1FBYTVDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUMzQixjQUFjLEVBQ2QsSUFBSSxFQUNKLElBQUksQ0FBQyxxQkFBcUIsQ0FDM0IsQ0FBQTtRQUNELElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUMz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Q0FBQyxJQUFJLGVBQWUsRUFBRTtnQkFDL0IsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTthQUNuRDtTQUNGO0lBQ0gsQ0FBQztJQUVPLHdDQUF1QixHQUEvQixVQUFnQyxLQUF1QjtRQUNyRCxvRUFBb0U7UUFDcEUsNkRBQTZEO1FBQ3JELElBQUEsTUFBTSxHQUFvQixLQUFLLE9BQXpCLEVBQUUsYUFBYSxHQUFLLEtBQUssY0FBVixDQUFVO1FBRXZDLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFO1lBQUUsT0FBTTtRQUVyQyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBRW5ELElBQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsQ0FBQTtRQUU1RCxJQUFJLGVBQWUsRUFBRTtZQUNuQixLQUFLLElBQU0sQ0FBQyxJQUFJLGVBQWUsRUFBRTtnQkFDL0IsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTthQUNuRDtTQUNGO0lBQ0gsQ0FBQztJQUNILGFBQUM7QUFBRCxDQUFDLEFBM2JELElBMmJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSUVuZ2luZSxcbiAgSVN5c3RlbSxcbiAgSUVudGl0eSxcbiAgQ29tcG9uZW50QWRkZWQsXG4gIENvbXBvbmVudFJlbW92ZWRcbn0gZnJvbSAnLi9JRW50aXR5J1xuXG5pbXBvcnQge1xuICBnZXRDb21wb25lbnROYW1lLFxuICBnZXRDb21wb25lbnRJZCxcbiAgRGlzcG9zYWJsZUNvbXBvbmVudFVwZGF0ZWQsXG4gIERpc3Bvc2FibGVDb21wb25lbnRMaWtlLFxuICBDb21wb25lbnRDb25zdHJ1Y3RvcixcbiAgRGlzcG9zYWJsZUNvbXBvbmVudENyZWF0ZWQsXG4gIERpc3Bvc2FibGVDb21wb25lbnRSZW1vdmVkLFxuICBnZXRDb21wb25lbnRDbGFzc0lkXG59IGZyb20gJy4vQ29tcG9uZW50J1xuaW1wb3J0IHsgRXZlbnRNYW5hZ2VyIH0gZnJvbSAnLi9FdmVudE1hbmFnZXInXG5pbXBvcnQgeyBDb21wb25lbnRHcm91cCB9IGZyb20gJy4vQ29tcG9uZW50R3JvdXAnXG5cbmltcG9ydCB7IGxvZywgZXJyb3IgfSBmcm9tICcuL2hlbHBlcnMnXG5pbXBvcnQgeyBFbnRpdHkgfSBmcm9tICcuL0VudGl0eSdcblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xudHlwZSBTeXN0ZW1FbnRyeSA9IHsgc3lzdGVtOiBJU3lzdGVtOyBwcmlvcml0eTogbnVtYmVyIH1cblxuLyoqXG4gKiBAcHVibGljXG4gKi9cbmV4cG9ydCBjbGFzcyBFbmdpbmUgaW1wbGVtZW50cyBJRW5naW5lIHtcbiAgcmVhZG9ubHkgZXZlbnRNYW5hZ2VyOiBFdmVudE1hbmFnZXIgPSBuZXcgRXZlbnRNYW5hZ2VyKClcbiAgcmVhZG9ubHkgcm9vdEVudGl0eTogSUVudGl0eVxuICByZWFkb25seSBmaXJzdFBlcnNvbkNhbWVyYUVudGl0eTogSUVudGl0eVxuICByZWFkb25seSBhdmF0YXJFbnRpdHk6IElFbnRpdHlcblxuICAvLyBAaW50ZXJuYWxcbiAgcmVhZG9ubHkgc3lzdGVtczogU3lzdGVtRW50cnlbXSA9IFtdXG5cbiAgLy8gQGludGVybmFsXG4gIHJlYWRvbmx5IGVudGl0eUxpc3RzOiBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBJRW50aXR5Pj4gPSB7fVxuXG4gIC8vIEBpbnRlcm5hbFxuICByZWFkb25seSBhZGRlZFN5c3RlbXM6IElTeXN0ZW1bXSA9IFtdXG5cbiAgcHJpdmF0ZSByZWFkb25seSBfZW50aXRpZXM6IFJlY29yZDxzdHJpbmcsIElFbnRpdHk+ID0ge31cbiAgcHJpdmF0ZSByZWFkb25seSBfZGlzcG9zYWJsZUNvbXBvbmVudHM6IFJlY29yZDxcbiAgICBzdHJpbmcsXG4gICAgRGlzcG9zYWJsZUNvbXBvbmVudExpa2VcbiAgPiA9IHt9XG4gIHByaXZhdGUgcmVhZG9ubHkgX2NvbXBvbmVudEdyb3VwczogUmVjb3JkPHN0cmluZywgQ29tcG9uZW50R3JvdXBbXT4gPSB7fVxuXG4gIC8vIHN5c3RlbXMgdGhhdCBkb2Vzbid0IHJlcXVpcmUgYW55IGNvbXBvbmVudCBvciBoYW5kbGUgdGhlaXIgb3duIGxvZ2ljXG4gIHByaXZhdGUgcmVhZG9ubHkgc2ltcGxlU3lzdGVtczogSVN5c3RlbVtdID0gW11cblxuICBnZXQgZW50aXRpZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2VudGl0aWVzIGFzIFJlYWRvbmx5PFJlY29yZDxzdHJpbmcsIElFbnRpdHk+PlxuICB9XG5cbiAgZ2V0IGRpc3Bvc2FibGVDb21wb25lbnRzKCkge1xuICAgIHJldHVybiB0aGlzLl9kaXNwb3NhYmxlQ29tcG9uZW50cyBhcyBSZWFkb25seTxcbiAgICAgIFJlY29yZDxzdHJpbmcsIERpc3Bvc2FibGVDb21wb25lbnRMaWtlPlxuICAgID5cbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHJvb3RFbnRpdHk6IElFbnRpdHkpIHtcbiAgICB0aGlzLmV2ZW50TWFuYWdlci5hZGRMaXN0ZW5lcihcbiAgICAgIENvbXBvbmVudEFkZGVkLFxuICAgICAgdGhpcyxcbiAgICAgIHRoaXMuY29tcG9uZW50QWRkZWRIYW5kbGVyXG4gICAgKVxuICAgIHRoaXMuZXZlbnRNYW5hZ2VyLmFkZExpc3RlbmVyKFxuICAgICAgQ29tcG9uZW50UmVtb3ZlZCxcbiAgICAgIHRoaXMsXG4gICAgICB0aGlzLmNvbXBvbmVudFJlbW92ZWRIYW5kbGVyXG4gICAgKVxuICAgIHRoaXMucm9vdEVudGl0eSA9IHJvb3RFbnRpdHlcbiAgICB0aGlzLmZpcnN0UGVyc29uQ2FtZXJhRW50aXR5ID0gbmV3IEVudGl0eSgpXG4gICAgOyh0aGlzLmZpcnN0UGVyc29uQ2FtZXJhRW50aXR5IGFzIGFueSkudXVpZCA9XG4gICAgICAnRmlyc3RQZXJzb25DYW1lcmFFbnRpdHlSZWZlcmVuY2UnXG4gICAgdGhpcy5hZGRFbnRpdHkodGhpcy5maXJzdFBlcnNvbkNhbWVyYUVudGl0eSlcbiAgICB0aGlzLmF2YXRhckVudGl0eSA9IG5ldyBFbnRpdHkoKVxuICAgIDsodGhpcy5hdmF0YXJFbnRpdHkgYXMgYW55KS51dWlkID0gJ0F2YXRhckVudGl0eVJlZmVyZW5jZSdcbiAgICB0aGlzLmFkZEVudGl0eSh0aGlzLmF2YXRhckVudGl0eSlcbiAgfVxuXG4gIGFkZEVudGl0eShlbnRpdHk6IElFbnRpdHkpOiBJRW50aXR5IHtcbiAgICBjb25zdCBwYXJlbnQgPSBlbnRpdHkuZ2V0UGFyZW50KClcblxuICAgIGlmIChlbnRpdHkuaXNBZGRlZFRvRW5naW5lKCkpIHtcbiAgICAgIHJldHVybiBlbnRpdHlcbiAgICB9XG5cbiAgICBlbnRpdHkuZXZlbnRNYW5hZ2VyID0gdGhpcy5ldmVudE1hbmFnZXJcbiAgICA7KGVudGl0eSBhcyBFbnRpdHkpLmVuZ2luZSA9IHRoaXNcblxuICAgIHRoaXMuX2VudGl0aWVzW2VudGl0eS51dWlkXSA9IGVudGl0eVxuXG4gICAgdGhpcy5jaGVja1JlcXVpcmVtZW50c0FuZEFkZChlbnRpdHkpXG5cbiAgICBpZiAoIXBhcmVudCkge1xuICAgICAgZW50aXR5LnNldFBhcmVudCh0aGlzLnJvb3RFbnRpdHkpXG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghcGFyZW50LmlzQWRkZWRUb0VuZ2luZSgpICYmIHBhcmVudCAhPT0gdGhpcy5yb290RW50aXR5KSB7XG4gICAgICAgIGxvZyhcbiAgICAgICAgICAnRW5naW5lOiB3YXJuaW5nLCBhZGRlZCBhbiBlbnRpdHkgd2l0aCBhIHBhcmVudCBub3QgcHJlc2VudCBpbiB0aGUgZW5naW5lLiBQYXJlbnQgaWQ6ICcgK1xuICAgICAgICAgICAgcGFyZW50LnV1aWRcbiAgICAgICAgKVxuICAgICAgfVxuICAgIH1cblxuICAgIGVudGl0eS5hbGl2ZSA9IHRydWVcblxuICAgIGZvciAoY29uc3QgaSBpbiBlbnRpdHkuY2hpbGRyZW4pIHtcbiAgICAgIGNvbnN0IGNoaWxkID0gZW50aXR5LmNoaWxkcmVuW2ldXG4gICAgICBpZiAoY2hpbGQpIHtcbiAgICAgICAgaWYgKCFjaGlsZC5pc0FkZGVkVG9FbmdpbmUoKSkge1xuICAgICAgICAgIHRoaXMuYWRkRW50aXR5KGNoaWxkKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGVudGl0eVxuICB9XG5cbiAgcmVtb3ZlRW50aXR5KGVudGl0eTogSUVudGl0eSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGlkID0gZW50aXR5LnV1aWRcblxuICAgIGlmIChlbnRpdHkuaXNBZGRlZFRvRW5naW5lKCkpIHtcbiAgICAgIGZvciAoY29uc3QgY29tcG9uZW50TmFtZSBpbiBlbnRpdHkuY29tcG9uZW50cykge1xuICAgICAgICBjb25zdCBjb21wb25lbnRHcm91cHMgPSB0aGlzLl9jb21wb25lbnRHcm91cHNbY29tcG9uZW50TmFtZV1cblxuICAgICAgICBpZiAoY29tcG9uZW50R3JvdXBzKSB7XG4gICAgICAgICAgZm9yIChjb25zdCBncm91cEluZGV4IGluIGNvbXBvbmVudEdyb3Vwcykge1xuICAgICAgICAgICAgY29tcG9uZW50R3JvdXBzW2dyb3VwSW5kZXhdLnJlbW92ZUVudGl0eShlbnRpdHkpXG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuZW50aXR5TGlzdHNbY29tcG9uZW50TmFtZV1baWRdXG4gICAgICB9XG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zaW1wbGVTeXN0ZW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHN5c3RlbSA9IHRoaXMuc2ltcGxlU3lzdGVtc1tpXVxuXG4gICAgICAgIGlmIChzeXN0ZW0ub25SZW1vdmVFbnRpdHkpIHtcbiAgICAgICAgICBzeXN0ZW0ub25SZW1vdmVFbnRpdHkoZW50aXR5KVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGZvciAoY29uc3QgaSBpbiBlbnRpdHkuY2hpbGRyZW4pIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBlbnRpdHkuY2hpbGRyZW5baV1cbiAgICAgICAgaWYgKGNoaWxkKSB7XG4gICAgICAgICAgdGhpcy5yZW1vdmVFbnRpdHkoY2hpbGQpXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgZW50aXR5LmFsaXZlID0gZmFsc2VcbiAgICAgIGVudGl0eS5ldmVudE1hbmFnZXIgPSBudWxsXG5cbiAgICAgIGRlbGV0ZSB0aGlzLl9lbnRpdGllc1tpZF1cblxuICAgICAgcmV0dXJuIHRydWVcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nKCdFbmdpbmU6IFRyeWluZyB0byByZW1vdmUgbm9uIGV4aXN0ZW50IGVudGl0eSBmcm9tIGVuZ2luZS4nKVxuICAgICAgaWYgKCFlbnRpdHkuaXNBZGRlZFRvRW5naW5lKCkpIHtcbiAgICAgICAgbG9nKFxuICAgICAgICAgIGBFbmdpbmU6IEVudGl0eSBcIiR7ZW50aXR5LnV1aWR9XCIgaGFzIG5vdCBiZWVuIGFkZGVkIHRvIGFueSBlbmdpbmUgeWV0LmBcbiAgICAgICAgKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nKCdFbmdpbmU6IEVudGl0eSBpZDogJyArIGlkKVxuICAgICAgfVxuICAgICAgbG9nKFwiRW5naW5lOiBFbnRpdHkncyBjb21wb25lbnRzOlwiKVxuICAgICAgZm9yIChjb25zdCBjb21wb25lbnROYW1lIGluIGVudGl0eS5jb21wb25lbnRzKSB7XG4gICAgICAgIGxvZyhjb21wb25lbnROYW1lKVxuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICB9XG5cbiAgYWRkU3lzdGVtKHN5c3RlbTogSVN5c3RlbSwgcHJpb3JpdHk6IG51bWJlciA9IDApIHtcbiAgICBpZiAodGhpcy5hZGRlZFN5c3RlbXMuaW5kZXhPZihzeXN0ZW0pICE9PSAtMSkge1xuICAgICAgbG9nKCdFbmdpbmU6IFRyeWluZyB0byBhZGQgYSBzeXN0ZW0gdGhhdCBpcyBhbHJlYWR5IGFkZGVkLiBBYm9ydGluZycpXG4gICAgICByZXR1cm4gc3lzdGVtXG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc3lzdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc3lzdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBlbnRyeSA9IHRoaXMuc3lzdGVtc1tpXVxuICAgICAgICBjb25zdCBpc0xhc3QgPSBpID09PSB0aGlzLnN5c3RlbXMubGVuZ3RoIC0gMVxuXG4gICAgICAgIGlmIChlbnRyeS5wcmlvcml0eSA+IHByaW9yaXR5KSB7XG4gICAgICAgICAgdGhpcy5hZGRlZFN5c3RlbXMucHVzaChzeXN0ZW0pXG4gICAgICAgICAgdGhpcy5zeXN0ZW1zLnNwbGljZShpLCAwLCB7IHN5c3RlbSwgcHJpb3JpdHkgfSlcbiAgICAgICAgICBicmVha1xuICAgICAgICB9IGVsc2UgaWYgKGlzTGFzdCkge1xuICAgICAgICAgIHRoaXMuYWRkZWRTeXN0ZW1zLnB1c2goc3lzdGVtKVxuICAgICAgICAgIHRoaXMuc3lzdGVtcy5zcGxpY2UoaSArIDEsIDAsIHsgc3lzdGVtLCBwcmlvcml0eSB9KVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5hZGRlZFN5c3RlbXMucHVzaChzeXN0ZW0pXG4gICAgICB0aGlzLnN5c3RlbXMuc3BsaWNlKDEsIDAsIHsgc3lzdGVtLCBwcmlvcml0eSB9KVxuICAgIH1cblxuICAgIHRoaXMucmVnaXN0ZXJTeXN0ZW0oc3lzdGVtKVxuXG4gICAgcmV0dXJuIHN5c3RlbVxuICB9XG5cbiAgcmVtb3ZlU3lzdGVtKHN5c3RlbTogSVN5c3RlbSkge1xuICAgIGNvbnN0IGlkeCA9IHRoaXMuYWRkZWRTeXN0ZW1zLmluZGV4T2Yoc3lzdGVtKVxuXG4gICAgaWYgKGlkeCAhPT0gLTEpIHtcbiAgICAgIHN5c3RlbS5hY3RpdmUgPSBmYWxzZVxuXG4gICAgICBpZiAoc3lzdGVtLmRlYWN0aXZhdGUpIHtcbiAgICAgICAgc3lzdGVtLmRlYWN0aXZhdGUoKVxuICAgICAgfVxuXG4gICAgICB0aGlzLmFkZGVkU3lzdGVtcy5zcGxpY2UoaWR4LCAxKVxuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc3lzdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBzeXMgPSB0aGlzLnN5c3RlbXNbaV0uc3lzdGVtXG4gICAgICAgIGlmIChzeXMgPT09IHN5c3RlbSkge1xuICAgICAgICAgIHRoaXMuc3lzdGVtcy5zcGxpY2UoaSwgMSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICB1cGRhdGUoZHQ6IG51bWJlcikge1xuICAgIGZvciAoY29uc3QgaSBpbiB0aGlzLnN5c3RlbXMpIHtcbiAgICAgIGNvbnN0IHN5c3RlbSA9IHRoaXMuc3lzdGVtc1tpXS5zeXN0ZW1cbiAgICAgIGlmIChzeXN0ZW0uYWN0aXZlICYmIHN5c3RlbS51cGRhdGUpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBzeXN0ZW0udXBkYXRlKGR0KVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgLy8gVE9ETzogZSBtYXkgbm90IGJlIGFuIEVycm9yXG4gICAgICAgICAgZXJyb3IoZSBhcyBhbnkpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXNcbiAgfVxuXG4gIGdldEVudGl0aWVzV2l0aENvbXBvbmVudChjb21wb25lbnQ6IHN0cmluZyk6IFJlY29yZDxzdHJpbmcsIGFueT5cbiAgZ2V0RW50aXRpZXNXaXRoQ29tcG9uZW50KFxuICAgIGNvbXBvbmVudDogQ29tcG9uZW50Q29uc3RydWN0b3I8YW55PlxuICApOiBSZWNvcmQ8c3RyaW5nLCBJRW50aXR5PlxuICBnZXRFbnRpdGllc1dpdGhDb21wb25lbnQoXG4gICAgY29tcG9uZW50OiBDb21wb25lbnRDb25zdHJ1Y3Rvcjxhbnk+IHwgc3RyaW5nXG4gICk6IFJlY29yZDxzdHJpbmcsIElFbnRpdHk+IHtcbiAgICBjb25zdCBjb21wb25lbnROYW1lID1cbiAgICAgIHR5cGVvZiBjb21wb25lbnQgPT09ICdzdHJpbmcnID8gY29tcG9uZW50IDogZ2V0Q29tcG9uZW50TmFtZShjb21wb25lbnQpXG5cbiAgICBpZiAoY29tcG9uZW50TmFtZSBpbiB0aGlzLmVudGl0eUxpc3RzKSB7XG4gICAgICByZXR1cm4gdGhpcy5lbnRpdHlMaXN0c1tjb21wb25lbnROYW1lXVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gKHRoaXMuZW50aXR5TGlzdHNbY29tcG9uZW50TmFtZV0gPSB7fSlcbiAgICB9XG4gIH1cblxuICByZWdpc3RlckNvbXBvbmVudChjb21wb25lbnQ6IERpc3Bvc2FibGVDb21wb25lbnRMaWtlKSB7XG4gICAgY29uc3QgaWQgPSBnZXRDb21wb25lbnRJZChjb21wb25lbnQpXG4gICAgY29uc3QgbmFtZSA9IGdldENvbXBvbmVudE5hbWUoY29tcG9uZW50KVxuICAgIGNvbnN0IGNsYXNzSWQgPSBnZXRDb21wb25lbnRDbGFzc0lkKGNvbXBvbmVudClcbiAgICB0aGlzLl9kaXNwb3NhYmxlQ29tcG9uZW50c1tpZF0gPSBjb21wb25lbnRcbiAgICBpZiAoY2xhc3NJZCAhPT0gbnVsbCkge1xuICAgICAgdGhpcy5ldmVudE1hbmFnZXIuZmlyZUV2ZW50KFxuICAgICAgICBuZXcgRGlzcG9zYWJsZUNvbXBvbmVudENyZWF0ZWQoaWQsIG5hbWUsIGNsYXNzSWQpXG4gICAgICApXG4gICAgICB0aGlzLmV2ZW50TWFuYWdlci5maXJlRXZlbnQobmV3IERpc3Bvc2FibGVDb21wb25lbnRVcGRhdGVkKGlkLCBjb21wb25lbnQpKVxuICAgIH1cbiAgfVxuXG4gIGRpc3Bvc2VDb21wb25lbnQoY29tcG9uZW50OiBEaXNwb3NhYmxlQ29tcG9uZW50TGlrZSkge1xuICAgIGNvbnN0IGlkID0gZ2V0Q29tcG9uZW50SWQoY29tcG9uZW50KVxuXG4gICAgaWYgKGRlbGV0ZSB0aGlzLl9kaXNwb3NhYmxlQ29tcG9uZW50c1tpZF0pIHtcbiAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyLmZpcmVFdmVudChuZXcgRGlzcG9zYWJsZUNvbXBvbmVudFJlbW92ZWQoaWQpKVxuXG4gICAgICBpZiAoY29tcG9uZW50Lm9uRGlzcG9zZSkge1xuICAgICAgICBjb21wb25lbnQub25EaXNwb3NlKClcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgdXBkYXRlQ29tcG9uZW50KGNvbXBvbmVudDogRGlzcG9zYWJsZUNvbXBvbmVudExpa2UpIHtcbiAgICB0aGlzLmV2ZW50TWFuYWdlci5maXJlRXZlbnQoXG4gICAgICBuZXcgRGlzcG9zYWJsZUNvbXBvbmVudFVwZGF0ZWQoZ2V0Q29tcG9uZW50SWQoY29tcG9uZW50KSwgY29tcG9uZW50KVxuICAgIClcbiAgfVxuXG4gIGdldENvbXBvbmVudEdyb3VwKC4uLnJlcXVpcmVzOiBDb21wb25lbnRDb25zdHJ1Y3Rvcjxhbnk+W10pIHtcbiAgICBsZXQgY29tcG9uZW50R3JvdXAgPSB1bmRlZmluZWRcblxuICAgIC8vIFJldHVybiBhbiBhbHJlYWR5IGNyZWF0ZWQgY29tcG9uZW50LWdyb3VwIGlmIGl0IGFscmVhZHkgZXhpc3RzXG4gICAgaWYgKHJlcXVpcmVzLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIDEuIGdldCBjb21wb25lbnQgZ3JvdXBzIGZvciBmaXJzdCByZXF1aXJlXG4gICAgICBjb25zdCBjb21wb25lbnRHcm91cHMgPVxuICAgICAgICB0aGlzLl9jb21wb25lbnRHcm91cHNbZ2V0Q29tcG9uZW50TmFtZShyZXF1aXJlc1swXSldXG5cbiAgICAgIGlmIChjb21wb25lbnRHcm91cHMpIHtcbiAgICAgICAgY29uc3QgY29tcG9uZW50cyA9IHJlcXVpcmVzLnNsaWNlKClcblxuICAgICAgICAvLyAyLiBzZWFyY2ggZm9yIGEgY29tcG9uZW50IGdyb3VwIHRoYXQgaGFzIGFsbCB0aGUgc2FtZSByZXF1aXJlbWVudHNcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb21wb25lbnRHcm91cHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBjb25zdCB0cmF2ZXJzZWRDb21wb25lbnRHcm91cCA9IGNvbXBvbmVudEdyb3Vwc1tpXVxuXG4gICAgICAgICAgaWYgKGNvbXBvbmVudHMubGVuZ3RoID09PSB0cmF2ZXJzZWRDb21wb25lbnRHcm91cC5yZXF1aXJlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgY29tcG9uZW50cy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgdHJhdmVyc2VkQ29tcG9uZW50R3JvdXAucmVxdWlyZXMuaW5kZXhPZihjb21wb25lbnRzW2pdKSA9PT0gLTFcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIGJyZWFrXG5cbiAgICAgICAgICAgICAgaWYgKGogPT09IGNvbXBvbmVudHMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICAgIGNvbXBvbmVudEdyb3VwID0gdHJhdmVyc2VkQ29tcG9uZW50R3JvdXBcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY29tcG9uZW50R3JvdXApIGJyZWFrXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGNvbXBvbmVudEdyb3VwKSB7XG4gICAgICAvLyAzLiBGb3VuZCBhbiBleGlzdGVudCBjb21wb25lbnQgZ3JvdXAgd2l0aCB0aGUgZXhhY3Qgc2FtZSByZXF1aXJlbWVudHNcbiAgICAgIHJldHVybiBjb21wb25lbnRHcm91cFxuICAgIH1cblxuICAgIC8vIE90aGVyd2lzZSBjcmVhdGUgYW5kIHN0b3JlIGl0XG4gICAgY29tcG9uZW50R3JvdXAgPSBuZXcgQ29tcG9uZW50R3JvdXAoLi4ucmVxdWlyZXMpXG5cbiAgICBjb21wb25lbnRHcm91cC5hY3RpdmUgPSB0cnVlXG5cbiAgICBjb25zdCByZXF1aXJlc05hbWVzID0gY29tcG9uZW50R3JvdXAucmVxdWlyZXNOYW1lc1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXF1aXJlc05hbWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBjb21wb25lbnROYW1lID0gcmVxdWlyZXNOYW1lc1tpXVxuXG4gICAgICBsZXQgY29tcG9uZW50R3JvdXBzID0gdGhpcy5fY29tcG9uZW50R3JvdXBzW2NvbXBvbmVudE5hbWVdXG5cbiAgICAgIGlmICghY29tcG9uZW50R3JvdXBzKSB7XG4gICAgICAgIHRoaXMuX2NvbXBvbmVudEdyb3Vwc1tjb21wb25lbnROYW1lXSA9IGNvbXBvbmVudEdyb3VwcyA9IFtdXG4gICAgICB9XG5cbiAgICAgIGlmIChjb21wb25lbnRHcm91cHMuaW5kZXhPZihjb21wb25lbnRHcm91cCkgPT09IC0xKSB7XG4gICAgICAgIGNvbXBvbmVudEdyb3Vwcy5wdXNoKGNvbXBvbmVudEdyb3VwKVxuICAgICAgfVxuICAgIH1cblxuICAgIGZvciAoY29uc3QgZW50aXR5SWQgaW4gdGhpcy5fZW50aXRpZXMpIHtcbiAgICAgIHRoaXMuY2hlY2tSZXF1aXJlbWVudHModGhpcy5fZW50aXRpZXNbZW50aXR5SWRdLCBjb21wb25lbnRHcm91cClcbiAgICB9XG5cbiAgICByZXR1cm4gY29tcG9uZW50R3JvdXBcbiAgfVxuXG4gIHJlbW92ZUNvbXBvbmVudEdyb3VwKGNvbXBvbmVudEdyb3VwOiBDb21wb25lbnRHcm91cCkge1xuICAgIGlmIChjb21wb25lbnRHcm91cC5hY3RpdmUpIHtcbiAgICAgIGNvbXBvbmVudEdyb3VwLmFjdGl2ZSA9IGZhbHNlXG4gICAgICBjb25zdCByZXF1aXJlc05hbWVzID0gY29tcG9uZW50R3JvdXAucmVxdWlyZXNOYW1lc1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXF1aXJlc05hbWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGNvbXBvbmVudE5hbWUgPSByZXF1aXJlc05hbWVzW2ldXG5cbiAgICAgICAgY29uc3QgY29tcG9uZW50R3JvdXBzID0gdGhpcy5fY29tcG9uZW50R3JvdXBzW2NvbXBvbmVudE5hbWVdXG5cbiAgICAgICAgaWYgKGNvbXBvbmVudEdyb3Vwcykge1xuICAgICAgICAgIGNvbnN0IGlkeCA9IGNvbXBvbmVudEdyb3Vwcy5pbmRleE9mKGNvbXBvbmVudEdyb3VwKVxuICAgICAgICAgIGlmIChpZHggIT09IC0xKSB7XG4gICAgICAgICAgICBjb21wb25lbnRHcm91cHMuc3BsaWNlKGlkeCwgMSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgcHJpdmF0ZSByZWdpc3RlclN5c3RlbShzeXN0ZW06IElTeXN0ZW0pIHtcbiAgICBzeXN0ZW0uYWN0aXZlID0gdHJ1ZVxuXG4gICAgaWYgKHN5c3RlbS5hY3RpdmF0ZSkge1xuICAgICAgc3lzdGVtLmFjdGl2YXRlKHRoaXMpXG4gICAgfVxuXG4gICAgdGhpcy5zaW1wbGVTeXN0ZW1zLnB1c2goc3lzdGVtKVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja1JlcXVpcmVtZW50c0FuZEFkZChlbnRpdHk6IElFbnRpdHkpIHtcbiAgICBpZiAoIWVudGl0eS5pc0FkZGVkVG9FbmdpbmUoKSkgcmV0dXJuXG5cbiAgICBmb3IgKGNvbnN0IGNvbXBvbmVudE5hbWUgaW4gZW50aXR5LmNvbXBvbmVudHMpIHtcbiAgICAgIGlmICghKGNvbXBvbmVudE5hbWUgaW4gdGhpcy5lbnRpdHlMaXN0cykpIHtcbiAgICAgICAgdGhpcy5lbnRpdHlMaXN0c1tjb21wb25lbnROYW1lXSA9IHt9XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZW50aXR5TGlzdHNbY29tcG9uZW50TmFtZV1bZW50aXR5LnV1aWRdID0gZW50aXR5XG5cbiAgICAgIGNvbnN0IGNvbXBvbmVudEdyb3VwcyA9IHRoaXMuX2NvbXBvbmVudEdyb3Vwc1tjb21wb25lbnROYW1lXVxuXG4gICAgICBpZiAoY29tcG9uZW50R3JvdXBzKSB7XG4gICAgICAgIGZvciAoY29uc3Qgc3lzdGVtSW5kZXggaW4gY29tcG9uZW50R3JvdXBzKSB7XG4gICAgICAgICAgdGhpcy5jaGVja1JlcXVpcmVtZW50cyhlbnRpdHksIGNvbXBvbmVudEdyb3Vwc1tzeXN0ZW1JbmRleF0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc2ltcGxlU3lzdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3Qgc3lzdGVtID0gdGhpcy5zaW1wbGVTeXN0ZW1zW2ldXG5cbiAgICAgIGlmIChzeXN0ZW0ub25BZGRFbnRpdHkpIHtcbiAgICAgICAgc3lzdGVtLm9uQWRkRW50aXR5KGVudGl0eSlcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNoZWNrUmVxdWlyZW1lbnRzKGVudGl0eTogSUVudGl0eSwgc3lzdGVtOiBDb21wb25lbnRHcm91cCkge1xuICAgIGlmIChzeXN0ZW0ubWVldHNSZXF1aXJlbWVudHMoZW50aXR5KSkge1xuICAgICAgaWYgKCFzeXN0ZW0uaGFzRW50aXR5KGVudGl0eSkpIHtcbiAgICAgICAgc3lzdGVtLmFkZEVudGl0eShlbnRpdHkpXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChzeXN0ZW0uaGFzRW50aXR5KGVudGl0eSkpIHtcbiAgICAgICAgc3lzdGVtLnJlbW92ZUVudGl0eShlbnRpdHkpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjb21wb25lbnRBZGRlZEhhbmRsZXIoZXZlbnQ6IENvbXBvbmVudEFkZGVkKSB7XG4gICAgY29uc3QgeyBlbnRpdHksIGNvbXBvbmVudE5hbWUgfSA9IGV2ZW50XG5cbiAgICBpZiAoIWVudGl0eS5pc0FkZGVkVG9FbmdpbmUoKSkgcmV0dXJuXG5cbiAgICBpZiAoIXRoaXMuZW50aXR5TGlzdHNbY29tcG9uZW50TmFtZV0pIHtcbiAgICAgIHRoaXMuZW50aXR5TGlzdHNbY29tcG9uZW50TmFtZV0gPSB7IFtlbnRpdHkudXVpZF06IGVudGl0eSB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZW50aXR5TGlzdHNbY29tcG9uZW50TmFtZV1bZW50aXR5LnV1aWRdID0gZW50aXR5XG4gICAgfVxuXG4gICAgY29uc3QgY29tcG9uZW50R3JvdXBzID0gdGhpcy5fY29tcG9uZW50R3JvdXBzW2NvbXBvbmVudE5hbWVdXG5cbiAgICBpZiAoY29tcG9uZW50R3JvdXBzKSB7XG4gICAgICBmb3IgKGNvbnN0IGkgaW4gY29tcG9uZW50R3JvdXBzKSB7XG4gICAgICAgIHRoaXMuY2hlY2tSZXF1aXJlbWVudHMoZW50aXR5LCBjb21wb25lbnRHcm91cHNbaV0pXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjb21wb25lbnRSZW1vdmVkSGFuZGxlcihldmVudDogQ29tcG9uZW50UmVtb3ZlZCkge1xuICAgIC8vIEluIGNhc2UgYSBzaW5nbGUgY29tcG9uZW50IGdldHMgcmVtb3ZlZCBmcm9tIGFuIGVudGl0eSwgd2UgaW5mb3JtXG4gICAgLy8gYWxsIHN5c3RlbXMgdGhhdCB0aGlzIGVudGl0eSBsb3N0IHRoaXMgc3BlY2lmaWMgY29tcG9uZW50LlxuICAgIGNvbnN0IHsgZW50aXR5LCBjb21wb25lbnROYW1lIH0gPSBldmVudFxuXG4gICAgaWYgKCFlbnRpdHkuaXNBZGRlZFRvRW5naW5lKCkpIHJldHVyblxuXG4gICAgZGVsZXRlIHRoaXMuZW50aXR5TGlzdHNbY29tcG9uZW50TmFtZV1bZW50aXR5LnV1aWRdXG5cbiAgICBjb25zdCBjb21wb25lbnRHcm91cHMgPSB0aGlzLl9jb21wb25lbnRHcm91cHNbY29tcG9uZW50TmFtZV1cblxuICAgIGlmIChjb21wb25lbnRHcm91cHMpIHtcbiAgICAgIGZvciAoY29uc3QgaSBpbiBjb21wb25lbnRHcm91cHMpIHtcbiAgICAgICAgdGhpcy5jaGVja1JlcXVpcmVtZW50cyhlbnRpdHksIGNvbXBvbmVudEdyb3Vwc1tpXSlcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==