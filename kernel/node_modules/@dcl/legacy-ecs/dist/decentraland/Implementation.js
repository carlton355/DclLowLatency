import { DisposableComponentCreated, DisposableComponentRemoved, DisposableComponentUpdated, getComponentClassId, getComponentId, isDisposableComponent, ObservableComponent } from '../ecs/Component';
import { ComponentAdded, ComponentRemoved, ParentChanged } from '../ecs/IEntity';
import { UUIDEvent, PointerEvent, RaycastResponse } from './Events';
// This number is defined in the protocol ECS.SetEntityParent.3
var ROOT_ENTITY_ID = '0';
var DecentralandSynchronizationSystem = /** @class */ (function () {
    function DecentralandSynchronizationSystem(dcl) {
        this.dcl = dcl;
        this.cachedComponents = {};
    }
    DecentralandSynchronizationSystem.prototype.activate = function (engine) {
        var _this = this;
        this.engine = engine;
        engine.eventManager.addListener(ComponentAdded, this, this.componentAdded);
        engine.eventManager.addListener(ComponentRemoved, this, this.componentRemoved);
        engine.eventManager.addListener(DisposableComponentCreated, this, this.disposableComponentCreated);
        engine.eventManager.addListener(DisposableComponentRemoved, this, this.disposableComponentRemoved);
        engine.eventManager.addListener(DisposableComponentUpdated, this, this.disposableComponentUpdated);
        engine.eventManager.addListener(ParentChanged, this, this.parentChanged);
        var rootId = engine.rootEntity.uuid;
        this.dcl.addEntity(rootId);
        // TODO(agus): send disposableComponents if exist
        this.dcl.onUpdate(function (dt) {
            engine.update(dt);
            _this.presentEntities();
        });
        this.dcl.onEvent(function (event) {
            var data = event.data;
            switch (event.type) {
                case 'uuidEvent':
                    engine.eventManager.fireEvent(new UUIDEvent(data.uuid, data.payload));
                    break;
                case 'raycastResponse':
                    if (data.queryType === 'HitFirst') {
                        engine.eventManager.fireEvent(new RaycastResponse(data));
                    }
                    else if (data.queryType === 'HitAll') {
                        engine.eventManager.fireEvent(new RaycastResponse(data));
                    }
                    break;
                case 'actionButtonEvent':
                    engine.eventManager.fireEvent(new PointerEvent(data.payload));
                    break;
            }
        });
    };
    /**
     * system.onAddEntity is called by the engine when a entity is added to the
     * engine.
     */
    DecentralandSynchronizationSystem.prototype.onAddEntity = function (entity) {
        if (entity && entity.isAddedToEngine()) {
            var entityId = entity.uuid;
            var parent = entity.getParent();
            this.dcl.addEntity(entityId);
            if (parent) {
                // If the entity has a parent, we send the the enparenting signal
                // otherwise the engine will know the entity is set as a child of
                // engine.rootEntity by default
                this.dcl.setParent(entityId, parent.uuid);
            }
            // This creates a cache dictionary to avoid send redundant information to
            // the engine in order to avoid unnecessary work in the main thread.
            this.cachedComponents[entityId] = {};
            // this iterator sends the current components of te engine at the moment
            // of addition
            for (var componentName in entity.components) {
                var component = entity.components[componentName];
                var classId = getComponentClassId(component);
                if (classId !== null) {
                    if (isDisposableComponent(component)) {
                        // Send the attach component signal
                        this.dcl.attachEntityComponent(entity.uuid, componentName, getComponentId(component));
                    }
                    else {
                        var componentJson = JSON.stringify(component);
                        // Send the updated component
                        this.dcl.updateEntityComponent(entityId, componentName, classId, componentJson);
                        // Update the cached copy of the sent component
                        this.cachedComponents[entityId][componentName] = componentJson;
                    }
                }
            }
        }
    };
    /**
     * system.onRemoveEntity is called by the engine when a entity gets removed
     * from the engine.
     */
    DecentralandSynchronizationSystem.prototype.onRemoveEntity = function (entity) {
        if (entity.isAddedToEngine()) {
            var entityId = entity.uuid;
            // Send the removeEntity signal
            this.dcl.removeEntity(entityId);
            // Remove the caches from local memory
            delete this.cachedComponents[entityId];
        }
    };
    /**
     * This method is called at the end of every update cycle.
     * It finds and sends updates in components of the engine entities.
     */
    DecentralandSynchronizationSystem.prototype.presentEntities = function () {
        for (var i in this.engine.entities) {
            var entity = this.engine.entities[i];
            for (var componentName in entity.components) {
                var component = entity.components[componentName];
                var classId = getComponentClassId(component);
                if (classId !== null && !isDisposableComponent(component)) {
                    var jsonRepresentation = this.getJsonIfDirty(entity.uuid, componentName, component);
                    if (jsonRepresentation) {
                        // Send the updated component
                        this.dcl.updateEntityComponent(entity.uuid, componentName, classId, jsonRepresentation);
                        this.clearDirty(entity.uuid, componentName, component, jsonRepresentation);
                    }
                }
            }
        }
        for (var id in this.engine.disposableComponents) {
            var component = this.engine.disposableComponents[id];
            if (component instanceof ObservableComponent && component.dirty) {
                this.dcl.componentUpdated(id, JSON.stringify(component));
                component.dirty = false;
            }
        }
    };
    /**
     * This method is called after a component is added to an entity. The event
     * (param 1) contains the necessary information to notify the engine about the
     * component that was added and the entity.
     */
    DecentralandSynchronizationSystem.prototype.componentAdded = function (event) {
        if (event.entity.isAddedToEngine()) {
            var component = event.entity.components[event.componentName];
            if (isDisposableComponent(component)) {
                this.dcl.attachEntityComponent(event.entity.uuid, event.componentName, getComponentId(component));
            }
            else if (event.classId !== null) {
                var componentJson = JSON.stringify(component);
                // Send the updated component
                this.dcl.updateEntityComponent(event.entity.uuid, event.componentName, event.classId, componentJson);
                // Update the cached copy of the sent component
                this.cachedComponents[event.entity.uuid][event.componentName] =
                    componentJson;
            }
        }
    };
    /**
     * This method is called when a component is removed from an entity.
     */
    DecentralandSynchronizationSystem.prototype.componentRemoved = function (event) {
        if (event.entity.isAddedToEngine()) {
            this.dcl.removeEntityComponent(event.entity.uuid, event.componentName);
            // Remove the cached component so we can send it again when re-adding
            delete this.cachedComponents[event.entity.uuid][event.componentName];
        }
    };
    /**
     * This method is called after a disposableComponent is created.
     * It instantiates the component in the engine, the event that updates the
     * created component is fired immediatly after.
     */
    DecentralandSynchronizationSystem.prototype.disposableComponentCreated = function (event) {
        this.dcl.componentCreated(event.componentId, event.componentName, event.classId);
    };
    /**
     * This method is called after a disposableComponent is updated, once per
     * update cycle and once after creation.
     */
    DecentralandSynchronizationSystem.prototype.disposableComponentRemoved = function (event) {
        this.dcl.componentDisposed(event.componentId);
    };
    /**
     * This method is called right after a diposableComponent gets disposed. That
     * process is manual.
     *
     * TODO(menduz,dani): What happens if a disposableComponent gets disposed and
     * it remains attached to some entities?
     */
    DecentralandSynchronizationSystem.prototype.disposableComponentUpdated = function (event) {
        this.dcl.componentUpdated(event.componentId, JSON.stringify(event.component));
    };
    /**
     * This method is called when a parent changes in an entity.
     */
    DecentralandSynchronizationSystem.prototype.parentChanged = function (event) {
        this.dcl.setParent(event.entity.uuid, event.parent ? event.parent.uuid : ROOT_ENTITY_ID);
    };
    DecentralandSynchronizationSystem.prototype.getJsonIfDirty = function (entityId, componentName, component) {
        var jsonRepresentation = JSON.stringify(component);
        return (jsonRepresentation !== this.cachedComponents[entityId][componentName] &&
            jsonRepresentation);
    };
    DecentralandSynchronizationSystem.prototype.clearDirty = function (entityId, componentName, component, jsonRepresentation) {
        this.cachedComponents[entityId][componentName] = jsonRepresentation;
    };
    return DecentralandSynchronizationSystem;
}());
export { DecentralandSynchronizationSystem };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW1wbGVtZW50YXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZGVjZW50cmFsYW5kL0ltcGxlbWVudGF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCwwQkFBMEIsRUFDMUIsMEJBQTBCLEVBQzFCLDBCQUEwQixFQUMxQixtQkFBbUIsRUFDbkIsY0FBYyxFQUNkLHFCQUFxQixFQUNyQixtQkFBbUIsRUFDcEIsTUFBTSxrQkFBa0IsQ0FBQTtBQUV6QixPQUFPLEVBQ0wsY0FBYyxFQUNkLGdCQUFnQixFQUdoQixhQUFhLEVBQ2QsTUFBTSxnQkFBZ0IsQ0FBQTtBQUN2QixPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUUsTUFBTSxVQUFVLENBQUE7QUFHbkUsK0RBQStEO0FBQy9ELElBQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQTtBQUUxQjtJQUlFLDJDQUFtQixHQUEwQjtRQUExQixRQUFHLEdBQUgsR0FBRyxDQUF1QjtRQUg3QyxxQkFBZ0IsR0FBMkMsRUFBRSxDQUFBO0lBR2IsQ0FBQztJQUVqRCxvREFBUSxHQUFSLFVBQVMsTUFBYztRQUF2QixpQkEwREM7UUF6REMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUE7UUFDcEIsTUFBTSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsY0FBYyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUE7UUFDMUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQzdCLGdCQUFnQixFQUNoQixJQUFJLEVBQ0osSUFBSSxDQUFDLGdCQUFnQixDQUN0QixDQUFBO1FBQ0QsTUFBTSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQzdCLDBCQUEwQixFQUMxQixJQUFJLEVBQ0osSUFBSSxDQUFDLDBCQUEwQixDQUNoQyxDQUFBO1FBQ0QsTUFBTSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQzdCLDBCQUEwQixFQUMxQixJQUFJ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QWMsRUFDZCxrQkFBMEI7UUFFMUIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLGtCQUFrQixDQUFBO0lBQ3JFLENBQUM7SUFDSCx3Q0FBQztBQUFELENBQUMsQUFyU0QsSUFxU0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBEaXNwb3NhYmxlQ29tcG9uZW50Q3JlYXRlZCxcbiAgRGlzcG9zYWJsZUNvbXBvbmVudFJlbW92ZWQsXG4gIERpc3Bvc2FibGVDb21wb25lbnRVcGRhdGVkLFxuICBnZXRDb21wb25lbnRDbGFzc0lkLFxuICBnZXRDb21wb25lbnRJZCxcbiAgaXNEaXNwb3NhYmxlQ29tcG9uZW50LFxuICBPYnNlcnZhYmxlQ29tcG9uZW50XG59IGZyb20gJy4uL2Vjcy9Db21wb25lbnQnXG5pbXBvcnQgeyBFbmdpbmUgfSBmcm9tICcuLi9lY3MvRW5naW5lJ1xuaW1wb3J0IHtcbiAgQ29tcG9uZW50QWRkZWQsXG4gIENvbXBvbmVudFJlbW92ZWQsXG4gIElFbnRpdHksXG4gIElTeXN0ZW0sXG4gIFBhcmVudENoYW5nZWRcbn0gZnJvbSAnLi4vZWNzL0lFbnRpdHknXG5pbXBvcnQgeyBVVUlERXZlbnQsIFBvaW50ZXJFdmVudCwgUmF5Y2FzdFJlc3BvbnNlIH0gZnJvbSAnLi9FdmVudHMnXG5pbXBvcnQgeyBSYXljYXN0SGl0RW50aXRpZXMsIFJheWNhc3RIaXRFbnRpdHkgfSBmcm9tICcuL1BoeXNpY3NDYXN0J1xuXG4vLyBUaGlzIG51bWJlciBpcyBkZWZpbmVkIGluIHRoZSBwcm90b2NvbCBFQ1MuU2V0RW50aXR5UGFyZW50LjNcbmNvbnN0IFJPT1RfRU5USVRZX0lEID0gJzAnXG5cbmV4cG9ydCBjbGFzcyBEZWNlbnRyYWxhbmRTeW5jaHJvbml6YXRpb25TeXN0ZW0gaW1wbGVtZW50cyBJU3lzdGVtIHtcbiAgY2FjaGVkQ29tcG9uZW50czogUmVjb3JkPHN0cmluZywgUmVjb3JkPHN0cmluZywgc3RyaW5nPj4gPSB7fVxuICBlbmdpbmUhOiBFbmdpbmVcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgZGNsOiBEZWNlbnRyYWxhbmRJbnRlcmZhY2UpIHt9XG5cbiAgYWN0aXZhdGUoZW5naW5lOiBFbmdpbmUpIHtcbiAgICB0aGlzLmVuZ2luZSA9IGVuZ2luZVxuICAgIGVuZ2luZS5ldmVudE1hbmFnZXIuYWRkTGlzdGVuZXIoQ29tcG9uZW50QWRkZWQsIHRoaXMsIHRoaXMuY29tcG9uZW50QWRkZWQpXG4gICAgZW5naW5lLmV2ZW50TWFuYWdlci5hZGRMaXN0ZW5lcihcbiAgICAgIENvbXBvbmVudFJlbW92ZWQsXG4gICAgICB0aGlzLFxuICAgICAgdGhpcy5jb21wb25lbnRSZW1vdmVkXG4gICAgKVxuICAgIGVuZ2luZS5ldmVudE1hbmFnZXIuYWRkTGlzdGVuZXIoXG4gICAgICBEaXNwb3NhYmxlQ29tcG9uZW50Q3JlYXRlZCxcbiAgICAgIHRoaXMsXG4gICAgICB0aGlzLmRpc3Bvc2FibGVDb21wb25lbnRDcmVhdGVkXG4gICAgKVxuICAgIGVuZ2luZS5ldmVudE1hbmFnZXIuYWRkTGlzdGVuZXIoXG4gICAgICBEaXNwb3NhYmxlQ29tcG9uZW50UmVtb3ZlZCxcbiAgICAgIHRoaXMsXG4gICAgICB0aGlzLmRpc3Bvc2FibGVDb21wb25lbnRSZW1vdmVkXG4gICAgKVxuICAgIGVuZ2luZS5ldmVudE1hbmFnZXIuYWRkTGlzdGVuZXIoXG4gICAgICBEaXNwb3NhYmxlQ29tcG9uZW50VXBkYXRlZCxcbiAgICAgIHRoaXMsXG4gICAgICB0aGlzLmRpc3Bvc2FibGVDb21wb25lbnRVcGRhdGVkXG4gICAgKVxuICAgIGVuZ2luZS5ldmVudE1hbmFnZXIuYWRkTGlzdGVuZXIoUGFyZW50Q2hhbmdlZCwgdGhpcywgdGhpcy5wYXJlbnRDaGFuZ2VkKVxuXG4gICAgY29uc3Qgcm9vdElkID0gZW5naW5lLnJvb3RFbnRpdHkudXVpZFxuXG4gICAgdGhpcy5kY2wuYWRkRW50aXR5KHJvb3RJZClcblxuICAgIC8vIFRPRE8oYWd1cyk6IHNlbmQgZGlzcG9zYWJsZUNvbXBvbmVudHMgaWYgZXhpc3RcblxuICAgIHRoaXMuZGNsLm9uVXBkYXRlKChkdCkgPT4ge1xuICAgICAgZW5naW5lLnVwZGF0ZShkdClcbiAgICAgIHRoaXMucHJlc2VudEVudGl0aWVzKClcbiAgICB9KVxuXG4gICAgdGhpcy5kY2wub25FdmVudCgoZXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBldmVudC5kYXRhIGFzIGFueVxuICAgICAgc3dpdGNoIChldmVudC50eXBlKSB7XG4gICAgICAgIGNhc2UgJ3V1aWRFdmVudCc6XG4gICAgICAgICAgZW5naW5lLmV2ZW50TWFuYWdlci5maXJlRXZlbnQobmV3IFVVSURFdmVudChkYXRhLnV1aWQsIGRhdGEucGF5bG9hZCkpXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAncmF5Y2FzdFJlc3BvbnNlJzpcbiAgICAgICAgICBpZiAoZGF0YS5xdWVyeVR5cGUgPT09ICdIaXRGaXJzdCcpIHtcbiAgICAgICAgICAgIGVuZ2luZS5ldmVudE1hbmFnZXIuZmlyZUV2ZW50KFxuICAgICAgICAgICAgICBuZXcgUmF5Y2FzdFJlc3BvbnNlPFJheWNhc3RIaXRFbnRpdHk+KGRhdGEpXG4gICAgICAgICAgICApXG4gICAgICAgICAgfSBlbHNlIGlmIChkYXRhLnF1ZXJ5VHlwZSA9PT0gJ0hpdEFsbCcpIHtcbiAgICAgICAgICAgIGVuZ2luZS5ldmVudE1hbmFnZXIuZmlyZUV2ZW50KFxuICAgICAgICAgICAgICBuZXcgUmF5Y2FzdFJlc3BvbnNlPFJheWNhc3RIaXRFbnRpdGllcz4oZGF0YSlcbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAnYWN0aW9uQnV0dG9uRXZlbnQnOlxuICAgICAgICAgIGVuZ2luZS5ldmVudE1hbmFnZXIuZmlyZUV2ZW50KG5ldyBQb2ludGVyRXZlbnQoZGF0YS5wYXlsb2FkKSlcbiAgICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICogc3lzdGVtLm9uQWRkRW50aXR5IGlzIGNhbGxlZCBieSB0aGUgZW5naW5lIHdoZW4gYSBlbnRpdHkgaXMgYWRkZWQgdG8gdGhlXG4gICAqIGVuZ2luZS5cbiAgICovXG4gIG9uQWRkRW50aXR5KGVudGl0eTogSUVudGl0eSkge1xuICAgIGlmIChlbnRpdHkgJiYgZW50aXR5LmlzQWRkZWRUb0VuZ2luZSgpKSB7XG4gICAgICBjb25zdCBlbnRpdHlJZCA9IGVudGl0eS51dWlkXG4gICAgICBjb25zdCBwYXJlbnQgPSBlbnRpdHkuZ2V0UGFyZW50KClcblxuICAgICAgdGhpcy5kY2wuYWRkRW50aXR5KGVudGl0eUlkKVxuXG4gICAgICBpZiAocGFyZW50KSB7XG4gICAgICAgIC8vIElmIHRoZSBlbnRpdHkgaGFzIGEgcGFyZW50LCB3ZSBzZW5kIHRoZSB0aGUgZW5wYXJlbnRpbmcgc2lnbmFsXG4gICAgICAgIC8vIG90aGVyd2lzZSB0aGUgZW5naW5lIHdpbGwga25vdyB0aGUgZW50aXR5IGlzIHNldCBhcyBhIGNoaWxkIG9mXG4gICAgICAgIC8vIGVuZ2luZS5yb290RW50aXR5IGJ5IGRlZmF1bHRcbiAgICAgICAgdGhpcy5kY2wuc2V0UGFyZW50KGVudGl0eUlkLCBwYXJlbnQudXVpZClcbiAgICAgIH1cblxuICAgICAgLy8gVGhpcyBjcmVhdGVzIGEgY2FjaGUgZGljdGlvbmFyeSB0byBhdm9pZCBzZW5kIHJlZHVuZGFudCBpbmZvcm1hdGlvbiB0b1xuICAgICAgLy8gdGhlIGVuZ2luZSBpbiBvcmRlciB0byBhdm9pZCB1bm5lY2Vzc2FyeSB3b3JrIGluIHRoZSBtYWluIHRocmVhZC5cbiAgICAgIHRoaXMuY2FjaGVkQ29tcG9uZW50c1tlbnRpdHlJZF0gPSB7fVxuXG4gICAgICAvLyB0aGlzIGl0ZXJhdG9yIHNlbmRzIHRoZSBjdXJyZW50IGNvbXBvbmVudHMgb2YgdGUgZW5naW5lIGF0IHRoZSBtb21lbnRcbiAgICAgIC8vIG9mIGFkZGl0aW9uXG4gICAgICBmb3IgKGNvbnN0IGNvbXBvbmVudE5hbWUgaW4gZW50aXR5LmNvbXBvbmVudHMpIHtcbiAgICAgICAgY29uc3QgY29tcG9uZW50ID0gZW50aXR5LmNvbXBvbmVudHNbY29tcG9uZW50TmFtZV1cbiAgICAgICAgY29uc3QgY2xhc3NJZCA9IGdldENvbXBvbmVudENsYXNzSWQoY29tcG9uZW50KVxuXG4gICAgICAgIGlmIChjbGFzc0lkICE9PSBudWxsKSB7XG4gICAgICAgICAgaWYgKGlzRGlzcG9zYWJsZUNvbXBvbmVudChjb21wb25lbnQpKSB7XG4gICAgICAgICAgICAvLyBTZW5kIHRoZSBhdHRhY2ggY29tcG9uZW50IHNpZ25hbFxuICAgICAgICAgICAgdGhpcy5kY2wuYXR0YWNoRW50aXR5Q29tcG9uZW50KFxuICAgICAgICAgICAgICBlbnRpdHkudXVpZCxcbiAgICAgICAgICAgICAgY29tcG9uZW50TmFtZSxcbiAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50SWQoY29tcG9uZW50KVxuICAgICAgICAgICAgKVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBjb21wb25lbnRKc29uOiBzdHJpbmcgPSBKU09OLnN0cmluZ2lmeShjb21wb25lbnQpXG5cbiAgICAgICAgICAgIC8vIFNlbmQgdGhlIHVwZGF0ZWQgY29tcG9uZW50XG4gICAgICAgICAgICB0aGlzLmRjbC51cGRhdGVFbnRpdHlDb21wb25lbnQoXG4gICAgICAgICAgICAgIGVudGl0eUlkLFxuICAgICAgICAgICAgICBjb21wb25lbnROYW1lLFxuICAgICAgICAgICAgICBjbGFzc0lkLFxuICAgICAgICAgICAgICBjb21wb25lbnRKc29uXG4gICAgICAgICAgICApXG5cbiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgY2FjaGVkIGNvcHkgb2YgdGhlIHNlbnQgY29tcG9uZW50XG4gICAgICAgICAgICB0aGlzLmNhY2hlZENvbXBvbmVudHNbZW50aXR5SWRdW2NvbXBvbmVudE5hbWVdID0gY29tcG9uZW50SnNvblxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBzeXN0ZW0ub25SZW1vdmVFbnRpdHkgaXMgY2FsbGVkIGJ5IHRoZSBlbmdpbmUgd2hlbiBhIGVudGl0eSBnZXRzIHJlbW92ZWRcbiAgICogZnJvbSB0aGUgZW5naW5lLlxuICAgKi9cbiAgb25SZW1vdmVFbnRpdHkoZW50aXR5OiBJRW50aXR5KSB7XG4gICAgaWYgKGVudGl0eS5pc0FkZGVkVG9FbmdpbmUoKSkge1xuICAgICAgY29uc3QgZW50aXR5SWQgPSBlbnRpdHkudXVpZFxuXG4gICAgICAvLyBTZW5kIHRoZSByZW1vdmVFbnRpdHkgc2lnbmFsXG4gICAgICB0aGlzLmRjbC5yZW1vdmVFbnRpdHkoZW50aXR5SWQpXG5cbiAgICAgIC8vIFJlbW92ZSB0aGUgY2FjaGVzIGZyb20gbG9jYWwgbWVtb3J5XG4gICAgICBkZWxldGUgdGhpcy5jYWNoZWRDb21wb25lbnRzW2VudGl0eUlkXVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgYXQgdGhlIGVuZCBvZiBldmVyeSB1cGRhdGUgY3ljbGUuXG4gICAqIEl0IGZpbmRzIGFuZCBzZW5kcyB1cGRhdGVzIGluIGNvbXBvbmVudHMgb2YgdGhlIGVuZ2luZSBlbnRpdGllcy5cbiAgICovXG4gIHByaXZhdGUgcHJlc2VudEVudGl0aWVzKCkge1xuICAgIGZvciAoY29uc3QgaSBpbiB0aGlzLmVuZ2luZS5lbnRpdGllcykge1xuICAgICAgY29uc3QgZW50aXR5ID0gdGhpcy5lbmdpbmUuZW50aXRpZXNbaV1cblxuICAgICAgZm9yIChjb25zdCBjb21wb25lbnROYW1lIGluIGVudGl0eS5jb21wb25lbnRzKSB7XG4gICAgICAgIGNvbnN0IGNvbXBvbmVudCA9IGVudGl0eS5jb21wb25lbnRzW2NvbXBvbmVudE5hbWVdXG4gICAgICAgIGNvbnN0IGNsYXNzSWQgPSBnZXRDb21wb25lbnRDbGFzc0lkKGNvbXBvbmVudClcblxuICAgICAgICBpZiAoY2xhc3NJZCAhPT0gbnVsbCAmJiAhaXNEaXNwb3NhYmxlQ29tcG9uZW50KGNvbXBvbmVudCkpIHtcbiAgICAgICAgICBjb25zdCBqc29uUmVwcmVzZW50YXRpb24gPSB0aGlzLmdldEpzb25JZkRpcnR5KFxuICAgICAgICAgICAgZW50aXR5LnV1aWQsXG4gICAgICAgICAgICBjb21wb25lbnROYW1lLFxuICAgICAgICAgICAgY29tcG9uZW50XG4gICAgICAgICAgKVxuICAgICAgICAgIGlmIChqc29uUmVwcmVzZW50YXRpb24pIHtcbiAgICAgICAgICAgIC8vIFNlbmQgdGhlIHVwZGF0ZWQgY29tcG9uZW50XG4gICAgICAgICAgICB0aGlzLmRjbC51cGRhdGVFbnRpdHlDb21wb25lbnQoXG4gICAgICAgICAgICAgIGVudGl0eS51dWlkLFxuICAgICAgICAgICAgICBjb21wb25lbnROYW1lLFxuICAgICAgICAgICAgICBjbGFzc0lkLFxuICAgICAgICAgICAgICBqc29uUmVwcmVzZW50YXRpb25cbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIHRoaXMuY2xlYXJEaXJ0eShcbiAgICAgICAgICAgICAgZW50aXR5LnV1aWQsXG4gICAgICAgICAgICAgIGNvbXBvbmVudE5hbWUsXG4gICAgICAgICAgICAgIGNvbXBvbmVudCxcbiAgICAgICAgICAgICAganNvblJlcHJlc2VudGF0aW9uXG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBpZCBpbiB0aGlzLmVuZ2luZS5kaXNwb3NhYmxlQ29tcG9uZW50cykge1xuICAgICAgY29uc3QgY29tcG9uZW50ID0gdGhpcy5lbmdpbmUuZGlzcG9zYWJsZUNvbXBvbmVudHNbaWRdXG4gICAgICBpZiAoY29tcG9uZW50IGluc3RhbmNlb2YgT2JzZXJ2YWJsZUNvbXBvbmVudCAmJiBjb21wb25lbnQuZGlydHkpIHtcbiAgICAgICAgdGhpcy5kY2wuY29tcG9uZW50VXBkYXRlZChpZCwgSlNPTi5zdHJpbmdpZnkoY29tcG9uZW50KSlcbiAgICAgICAgY29tcG9uZW50LmRpcnR5ID0gZmFsc2VcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgaXMgY2FsbGVkIGFmdGVyIGEgY29tcG9uZW50IGlzIGFkZGVkIHRvIGFuIGVudGl0eS4gVGhlIGV2ZW50XG4gICAqIChwYXJhbSAxKSBjb250YWlucyB0aGUgbmVjZXNzYXJ5IGluZm9ybWF0aW9uIHRvIG5vdGlmeSB0aGUgZW5naW5lIGFib3V0IHRoZVxuICAgKiBjb21wb25lbnQgdGhhdCB3YXMgYWRkZWQgYW5kIHRoZSBlbnRpdHkuXG4gICAqL1xuICBwcml2YXRlIGNvbXBvbmVudEFkZGVkKGV2ZW50OiBDb21wb25lbnRBZGRlZCkge1xuICAgIGlmIChldmVudC5lbnRpdHkuaXNBZGRlZFRvRW5naW5lKCkpIHtcbiAgICAgIGNvbnN0IGNvbXBvbmVudCA9IGV2ZW50LmVudGl0eS5jb21wb25lbnRzW2V2ZW50LmNvbXBvbmVudE5hbWVdXG5cbiAgICAgIGlmIChpc0Rpc3Bvc2FibGVDb21wb25lbnQoY29tcG9uZW50KSkge1xuICAgICAgICB0aGlzLmRjbC5hdHRhY2hFbnRpdHlDb21wb25lbnQoXG4gICAgICAgICAgZXZlbnQuZW50aXR5LnV1aWQsXG4gICAgICAgICAgZXZlbnQuY29tcG9uZW50TmFtZSxcbiAgICAgICAgICBnZXRDb21wb25lbnRJZChjb21wb25lbnQpXG4gICAgICAgIClcbiAgICAgIH0gZWxzZSBpZiAoZXZlbnQuY2xhc3NJZCAhPT0gbnVsbCkge1xuICAgICAgICBjb25zdCBjb21wb25lbnRKc29uOiBzdHJpbmcgPSBKU09OLnN0cmluZ2lmeShjb21wb25lbnQpXG5cbiAgICAgICAgLy8gU2VuZCB0aGUgdXBkYXRlZCBjb21wb25lbnRcbiAgICAgICAgdGhpcy5kY2wudXBkYXRlRW50aXR5Q29tcG9uZW50KFxuICAgICAgICAgIGV2ZW50LmVudGl0eS51dWlkLFxuICAgICAgICAgIGV2ZW50LmNvbXBvbmVudE5hbWUsXG4gICAgICAgICAgZXZlbnQuY2xhc3NJZCxcbiAgICAgICAgICBjb21wb25lbnRKc29uXG4gICAgICAgIClcblxuICAgICAgICAvLyBVcGRhdGUgdGhlIGNhY2hlZCBjb3B5IG9mIHRoZSBzZW50IGNvbXBvbmVudFxuICAgICAgICB0aGlzLmNhY2hlZENvbXBvbmVudHNbZXZlbnQuZW50aXR5LnV1aWRdW2V2ZW50LmNvbXBvbmVudE5hbWVdID1cbiAgICAgICAgICBjb21wb25lbnRKc29uXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCB3aGVuIGEgY29tcG9uZW50IGlzIHJlbW92ZWQgZnJvbSBhbiBlbnRpdHkuXG4gICAqL1xuICBwcml2YXRlIGNvbXBvbmVudFJlbW92ZWQoZXZlbnQ6IENvbXBvbmVudFJlbW92ZWQpIHtcbiAgICBpZiAoZXZlbnQuZW50aXR5LmlzQWRkZWRUb0VuZ2luZSgpKSB7XG4gICAgICB0aGlzLmRjbC5yZW1vdmVFbnRpdHlDb21wb25lbnQoZXZlbnQuZW50aXR5LnV1aWQsIGV2ZW50LmNvbXBvbmVudE5hbWUpXG5cbiAgICAgIC8vIFJlbW92ZSB0aGUgY2FjaGVkIGNvbXBvbmVudCBzbyB3ZSBjYW4gc2VuZCBpdCBhZ2FpbiB3aGVuIHJlLWFkZGluZ1xuICAgICAgZGVsZXRlIHRoaXMuY2FjaGVkQ29tcG9uZW50c1tldmVudC5lbnRpdHkudXVpZF1bZXZlbnQuY29tcG9uZW50TmFtZV1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgaXMgY2FsbGVkIGFmdGVyIGEgZGlzcG9zYWJsZUNvbXBvbmVudCBpcyBjcmVhdGVkLlxuICAgKiBJdCBpbnN0YW50aWF0ZXMgdGhlIGNvbXBvbmVudCBpbiB0aGUgZW5naW5lLCB0aGUgZXZlbnQgdGhhdCB1cGRhdGVzIHRoZVxuICAgKiBjcmVhdGVkIGNvbXBvbmVudCBpcyBmaXJlZCBpbW1lZGlhdGx5IGFmdGVyLlxuICAgKi9cbiAgcHJpdmF0ZSBkaXNwb3NhYmxlQ29tcG9uZW50Q3JlYXRlZChldmVudDogRGlzcG9zYWJsZUNvbXBvbmVudENyZWF0ZWQpIHtcbiAgICB0aGlzLmRjbC5jb21wb25lbnRDcmVhdGVkKFxuICAgICAgZXZlbnQuY29tcG9uZW50SWQsXG4gICAgICBldmVudC5jb21wb25lbnROYW1lLFxuICAgICAgZXZlbnQuY2xhc3NJZFxuICAgIClcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgYWZ0ZXIgYSBkaXNwb3NhYmxlQ29tcG9uZW50IGlzIHVwZGF0ZWQsIG9uY2UgcGVyXG4gICAqIHVwZGF0ZSBjeWNsZSBhbmQgb25jZSBhZnRlciBjcmVhdGlvbi5cbiAgICovXG4gIHByaXZhdGUgZGlzcG9zYWJsZUNvbXBvbmVudFJlbW92ZWQoZXZlbnQ6IERpc3Bvc2FibGVDb21wb25lbnRSZW1vdmVkKSB7XG4gICAgdGhpcy5kY2wuY29tcG9uZW50RGlzcG9zZWQoZXZlbnQuY29tcG9uZW50SWQpXG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgaXMgY2FsbGVkIHJpZ2h0IGFmdGVyIGEgZGlwb3NhYmxlQ29tcG9uZW50IGdldHMgZGlzcG9zZWQuIFRoYXRcbiAgICogcHJvY2VzcyBpcyBtYW51YWwuXG4gICAqXG4gICAqIFRPRE8obWVuZHV6LGRhbmkpOiBXaGF0IGhhcHBlbnMgaWYgYSBkaXNwb3NhYmxlQ29tcG9uZW50IGdldHMgZGlzcG9zZWQgYW5kXG4gICAqIGl0IHJlbWFpbnMgYXR0YWNoZWQgdG8gc29tZSBlbnRpdGllcz9cbiAgICovXG4gIHByaXZhdGUgZGlzcG9zYWJsZUNvbXBvbmVudFVwZGF0ZWQoZXZlbnQ6IERpc3Bvc2FibGVDb21wb25lbnRVcGRhdGVkKSB7XG4gICAgdGhpcy5kY2wuY29tcG9uZW50VXBkYXRlZChcbiAgICAgIGV2ZW50LmNvbXBvbmVudElkLFxuICAgICAgSlNPTi5zdHJpbmdpZnkoZXZlbnQuY29tcG9uZW50KVxuICAgIClcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgd2hlbiBhIHBhcmVudCBjaGFuZ2VzIGluIGFuIGVudGl0eS5cbiAgICovXG4gIHByaXZhdGUgcGFyZW50Q2hhbmdlZChldmVudDogUGFyZW50Q2hhbmdlZCkge1xuICAgIHRoaXMuZGNsLnNldFBhcmVudChcbiAgICAgIGV2ZW50LmVudGl0eS51dWlkLFxuICAgICAgZXZlbnQucGFyZW50ID8gZXZlbnQucGFyZW50LnV1aWQgOiBST09UX0VOVElUWV9JRFxuICAgIClcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SnNvbklmRGlydHkoXG4gICAgZW50aXR5SWQ6IHN0cmluZyxcbiAgICBjb21wb25lbnROYW1lOiBzdHJpbmcsXG4gICAgY29tcG9uZW50OiBhbnlcbiAgKTogZmFsc2UgfCBzdHJpbmcge1xuICAgIGNvbnN0IGpzb25SZXByZXNlbnRhdGlvbiA9IEpTT04uc3RyaW5naWZ5KGNvbXBvbmVudClcbiAgICByZXR1cm4gKFxuICAgICAganNvblJlcHJlc2VudGF0aW9uICE9PSB0aGlzLmNhY2hlZENvbXBvbmVudHNbZW50aXR5SWRdW2NvbXBvbmVudE5hbWVdICYmXG4gICAgICBqc29uUmVwcmVzZW50YXRpb25cbiAgICApXG4gIH1cblxuICBwcml2YXRlIGNsZWFyRGlydHkoXG4gICAgZW50aXR5SWQ6IHN0cmluZyxcbiAgICBjb21wb25lbnROYW1lOiBzdHJpbmcsXG4gICAgY29tcG9uZW50OiBhbnksXG4gICAganNvblJlcHJlc2VudGF0aW9uOiBzdHJpbmdcbiAgKSB7XG4gICAgdGhpcy5jYWNoZWRDb21wb25lbnRzW2VudGl0eUlkXVtjb21wb25lbnROYW1lXSA9IGpzb25SZXByZXNlbnRhdGlvblxuICB9XG59XG4iXX0=