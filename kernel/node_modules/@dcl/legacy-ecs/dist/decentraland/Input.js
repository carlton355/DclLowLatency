var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
import { Vector3 } from '@dcl/ecs-math';
import { InputEventType } from './Types';
import { Component, DisposableComponent } from '../ecs/Component';
/**
 * @public
 */
export var ActionButton;
(function (ActionButton) {
    ActionButton["POINTER"] = "POINTER";
    ActionButton["PRIMARY"] = "PRIMARY";
    ActionButton["SECONDARY"] = "SECONDARY";
    ActionButton["ANY"] = "ANY";
    ActionButton["FORWARD"] = "FORWARD";
    ActionButton["BACKWARD"] = "BACKWARD";
    ActionButton["RIGHT"] = "RIGHT";
    ActionButton["LEFT"] = "LEFT";
    ActionButton["JUMP"] = "JUMP";
    ActionButton["WALK"] = "WALK";
    ActionButton["ACTION_3"] = "ACTION_3";
    ActionButton["ACTION_4"] = "ACTION_4";
    ActionButton["ACTION_5"] = "ACTION_5";
    ActionButton["ACTION_6"] = "ACTION_6";
})(ActionButton || (ActionButton = {}));
/**
 * @public
 */
var PointerEventComponent = /** @class */ (function () {
    function PointerEventComponent(callback) {
        this.callback = callback;
        if (!callback || !('apply' in callback) || !('call' in callback)) {
            throw new Error('Callback is not a function');
        }
        Input.ensureInstance();
    }
    return PointerEventComponent;
}());
export { PointerEventComponent };
/**
 * @public
 */
var GlobalPointerDown = /** @class */ (function (_super) {
    __extends(GlobalPointerDown, _super);
    function GlobalPointerDown() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    GlobalPointerDown = __decorate([
        Component('pointerDown')
    ], GlobalPointerDown);
    return GlobalPointerDown;
}(PointerEventComponent));
export { GlobalPointerDown };
/**
 * @public
 */
var GlobalPointerUp = /** @class */ (function (_super) {
    __extends(GlobalPointerUp, _super);
    function GlobalPointerUp() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    GlobalPointerUp = __decorate([
        Component('pointerUp')
    ], GlobalPointerUp);
    return GlobalPointerUp;
}(PointerEventComponent));
export { GlobalPointerUp };
/**
 * @public
 */
var Subscription = /** @class */ (function () {
    function Subscription(fn, useRaycast) {
        this.fn = fn;
        this.useRaycast = useRaycast;
    }
    return Subscription;
}());
export { Subscription };
/**
 * @public
 */
var Input = /** @class */ (function () {
    function Input() {
        // @internal
        this.buttonIdMapping = [
            ActionButton.POINTER,
            ActionButton.PRIMARY,
            ActionButton.SECONDARY,
            ActionButton.ANY,
            ActionButton.FORWARD,
            ActionButton.BACKWARD,
            ActionButton.RIGHT,
            ActionButton.LEFT,
            ActionButton.JUMP,
            ActionButton.WALK,
            ActionButton.ACTION_3,
            ActionButton.ACTION_4,
            ActionButton.ACTION_5,
            ActionButton.ACTION_6
        ];
        // @internal
        this.subscriptions = this.buttonIdMapping.reduce(function (acc, k) {
            var _a;
            return (__assign(__assign({}, acc), (_a = {}, _a[k] = { BUTTON_DOWN: [], BUTTON_UP: [] }, _a)));
        }, {});
        this.internalState = this.buttonIdMapping.reduce(function (acc, k) {
            var _a;
            return (__assign(__assign({}, acc), (_a = {}, _a[k] = { BUTTON_DOWN: false }, _a)));
        }, {});
    }
    Object.defineProperty(Input, "instance", {
        get: function () {
            Input.ensureInstance();
            return Input._instance;
        },
        enumerable: false,
        configurable: true
    });
    Input.ensureInstance = function () {
        if (!Input._instance) {
            Input._instance = new Input();
        }
    };
    /**
     * Allows to know if a button is pressed
     *
     * Returns true if the button is pressed
     * @param buttonId - The id of the button.
     */
    Input.prototype.isButtonPressed = function (buttonId) {
        return this.internalState[buttonId];
    };
    /**
     * Subscribes to an input event and triggers the provided callback.
     *
     * Returns a function that can be called to remove the subscription.
     * @param eventName - The name of the event (see InputEventKind).
     * @param buttonId - The id of the button.
     * @param useRaycast - Enables getting raycast information.
     * @param fn - A callback function to be called when the event is triggered.
     */
    Input.prototype.subscribe = function (eventName, buttonId, useRaycast, fn) {
        var _this = this;
        this.subscriptions[buttonId][eventName].push(new Subscription(fn, useRaycast));
        return function () {
            _this.unsubscribe(eventName, buttonId, fn);
        };
    };
    /**
     * Removes an existing input event subscription.
     * @param eventName - The name of the event (see InputEventKind).
     * @param buttonId - The id of the button.
     * @param fn - The callback function used when subscribing to the event.
     */
    Input.prototype.unsubscribe = function (eventName, buttonId, fn) {
        var index = this.getSubscriptionId(eventName, buttonId, fn);
        if (index > -1) {
            return this.subscriptions[buttonId][eventName].splice(index, 1);
        }
        return false;
    };
    Input.prototype.handlePointerEvent = function (data) {
        var button = this.getPointerById(data.buttonId);
        if (!button) {
            return;
        }
        var eventResult = __assign(__assign({}, data), { button: button, direction: new Vector3().copyFrom(data.direction), origin: new Vector3().copyFrom(data.origin), hit: undefined });
        var hit = data.hit
            ? __assign(__assign({}, data.hit), { hitPoint: new Vector3().copyFrom(data.hit.hitPoint), normal: new Vector3().copyFrom(data.hit.normal), worldNormal: new Vector3().copyFrom(data.hit.worldNormal) }) : undefined;
        if (data.type === InputEventType.DOWN) {
            this.internalState[button].BUTTON_DOWN = true;
            for (var i = 0; i < this.subscriptions[button]['BUTTON_DOWN'].length; i++) {
                var subscription = this.subscriptions[button]['BUTTON_DOWN'][i];
                // remove hit information when raycast is disabled
                if (subscription.useRaycast) {
                    eventResult.hit = hit;
                }
                else {
                    eventResult.hit = undefined;
                }
                subscription.fn(eventResult);
            }
            if (hit && hit.entityId && DisposableComponent.engine) {
                var entity = DisposableComponent.engine.entities[hit.entityId];
                var handler = entity && entity.getComponentOrNull(GlobalPointerDown);
                if (handler) {
                    eventResult.hit = hit;
                    handler.callback(eventResult);
                }
            }
        }
        else {
            this.internalState[button].BUTTON_DOWN = false;
            for (var i = 0; i < this.subscriptions[button]['BUTTON_UP'].length; i++) {
                var subscription = this.subscriptions[button]['BUTTON_UP'][i];
                // remove hit information when raycast is disabled
                if (subscription.useRaycast) {
                    eventResult.hit = hit;
                }
                else {
                    eventResult.hit = undefined;
                }
                subscription.fn(eventResult);
            }
            if (hit && hit.entityId && DisposableComponent.engine) {
                var entity = DisposableComponent.engine.entities[hit.entityId];
                var handler = entity && entity.getComponentOrNull(GlobalPointerUp);
                if (handler) {
                    eventResult.hit = hit;
                    handler.callback(eventResult);
                }
            }
        }
    };
    Input.prototype.getSubscriptionId = function (eventName, buttonId, fn) {
        for (var i = 0; i < this.subscriptions[buttonId][eventName].length; i++) {
            if (this.subscriptions[buttonId][eventName][i].fn === fn) {
                return i;
            }
        }
        return -1;
    };
    Input.prototype.getPointerById = function (id) {
        if (id < 0 || id >= this.buttonIdMapping.length) {
            return null;
        }
        var actionButton = this.buttonIdMapping[id];
        if (actionButton === ActionButton.ANY) {
            return null;
        }
        return actionButton;
    };
    return Input;
}());
export { Input };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW5wdXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZGVjZW50cmFsYW5kL0lucHV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGVBQWUsQ0FBQTtBQUV2QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sU0FBUyxDQUFBO0FBQ3hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUtqRTs7R0FFRztBQUNILE1BQU0sQ0FBTixJQUFZLFlBZVg7QUFmRCxXQUFZLFlBQVk7SUFDdEIsbUNBQW1CLENBQUE7SUFDbkIsbUNBQW1CLENBQUE7SUFDbkIsdUNBQXVCLENBQUE7SUFDdkIsMkJBQVcsQ0FBQTtJQUNYLG1DQUFtQixDQUFBO0lBQ25CLHFDQUFxQixDQUFBO0lBQ3JCLCtCQUFlLENBQUE7SUFDZiw2QkFBYSxDQUFBO0lBQ2IsNkJBQWEsQ0FBQTtJQUNiLDZCQUFhLENBQUE7SUFDYixxQ0FBcUIsQ0FBQTtJQUNyQixxQ0FBcUIsQ0FBQTtJQUNyQixxQ0FBcUIsQ0FBQTtJQUNyQixxQ0FBcUIsQ0FBQTtBQUN2QixDQUFDLEVBZlcsWUFBWSxLQUFaLFlBQVksUUFldkI7QUFzQkQ7O0dBRUc7QUFDSDtJQUNFLCtCQUNrQixRQUFpRDtRQUFqRCxhQUFRLEdBQVIsUUFBUSxDQUF5QztRQUVqRSxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsQ0FBQyxPQUFPLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sSUFBSSxRQUFRLENBQUMsRUFBRTtZQUNoRSxNQUFNLElBQUksS0FBSyxDQUFDLDRCQUE0QixDQUFDLENBQUE7U0FDOUM7UUFDRCxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUE7SUFDeEIsQ0FBQztJQUNILDRCQUFDO0FBQUQsQ0FBQyxBQVRELElBU0M7O0FBRUQ7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Q0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN2RSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRTtnQkFDeEQsT0FBTyxDQUFDLENBQUE7YUFDVDtTQUNGO1FBRUQsT0FBTyxDQUFDLENBQUMsQ0FBQTtJQUNYLENBQUM7SUFFTyw4QkFBYyxHQUF0QixVQUF1QixFQUFVO1FBQy9CLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEVBQUU7WUFDL0MsT0FBTyxJQUFJLENBQUE7U0FDWjtRQUVELElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUE7UUFFN0MsSUFBSSxZQUFZLEtBQUssWUFBWSxDQUFDLEdBQUcsRUFBRTtZQUNyQyxPQUFPLElBQUksQ0FBQTtTQUNaO1FBRUQsT0FBTyxZQUFZLENBQUE7SUFDckIsQ0FBQztJQUNILFlBQUM7QUFBRCxDQUFDLEFBN01ELElBNk1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmVjdG9yMyB9IGZyb20gJ0BkY2wvZWNzLW1hdGgnXG5cbmltcG9ydCB7IElucHV0RXZlbnRUeXBlIH0gZnJvbSAnLi9UeXBlcydcbmltcG9ydCB7IENvbXBvbmVudCwgRGlzcG9zYWJsZUNvbXBvbmVudCB9IGZyb20gJy4uL2Vjcy9Db21wb25lbnQnXG5cbi8qKiBAcHVibGljICovXG5leHBvcnQgdHlwZSBJbnB1dEV2ZW50S2luZCA9ICdCVVRUT05fRE9XTicgfCAnQlVUVE9OX1VQJ1xuXG4vKipcbiAqIEBwdWJsaWNcbiAqL1xuZXhwb3J0IGVudW0gQWN0aW9uQnV0dG9uIHtcbiAgUE9JTlRFUiA9ICdQT0lOVEVSJyxcbiAgUFJJTUFSWSA9ICdQUklNQVJZJyxcbiAgU0VDT05EQVJZID0gJ1NFQ09OREFSWScsXG4gIEFOWSA9ICdBTlknLFxuICBGT1JXQVJEID0gJ0ZPUldBUkQnLFxuICBCQUNLV0FSRCA9ICdCQUNLV0FSRCcsXG4gIFJJR0hUID0gJ1JJR0hUJyxcbiAgTEVGVCA9ICdMRUZUJyxcbiAgSlVNUCA9ICdKVU1QJyxcbiAgV0FMSyA9ICdXQUxLJyxcbiAgQUNUSU9OXzMgPSAnQUNUSU9OXzMnLFxuICBBQ1RJT05fNCA9ICdBQ1RJT05fNCcsXG4gIEFDVElPTl81ID0gJ0FDVElPTl81JyxcbiAgQUNUSU9OXzYgPSAnQUNUSU9OXzYnXG59XG5cbi8qKiBAcHVibGljICovXG5leHBvcnQgdHlwZSBJbnB1dFN0YXRlID0gUmVjb3JkPFxuICBBY3Rpb25CdXR0b24sXG4gIHtcbiAgICBCVVRUT05fRE9XTjogYm9vbGVhblxuICB9XG4+XG5cbi8qKiBAcHVibGljICovXG5leHBvcnQgdHlwZSBMb2NhbEFjdGlvbkJ1dHRvbkV2ZW50ID0gR2xvYmFsSW5wdXRFdmVudFJlc3VsdCAmIHtcbiAgb3JpZ2luOiBWZWN0b3IzXG4gIGRpcmVjdGlvbjogVmVjdG9yM1xuICBidXR0b246IEFjdGlvbkJ1dHRvblxuICBoaXQ/OiBHbG9iYWxJbnB1dEV2ZW50UmVzdWx0WydoaXQnXSAmIHtcbiAgICBoaXRQb2ludDogVmVjdG9yM1xuICAgIG5vcm1hbDogVmVjdG9yM1xuICAgIHdvcmxkTm9ybWFsOiBWZWN0b3IzXG4gIH1cbn1cblxuLyoqXG4gKiBAcHVibGljXG4gKi9cbmV4cG9ydCBjbGFzcyBQb2ludGVyRXZlbnRDb21wb25lbnQge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgY2FsbGJhY2s6IChldmVudDogTG9jYWxBY3Rpb25CdXR0b25FdmVudCkgPT4gdm9pZFxuICApIHtcbiAgICBpZiAoIWNhbGxiYWNrIHx8ICEoJ2FwcGx5JyBpbiBjYWxsYmFjaykgfHwgISgnY2FsbCcgaW4gY2FsbGJhY2spKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhbGxiYWNrIGlzIG5vdCBhIGZ1bmN0aW9uJylcbiAgICB9XG4gICAgSW5wdXQuZW5zdXJlSW5zdGFuY2UoKVxuICB9XG59XG5cbi8qKlxuICogQHB1YmxpY1xuICovXG5AQ29tcG9uZW50KCdwb2ludGVyRG93bicpXG5leHBvcnQgY2xhc3MgR2xvYmFsUG9pbnRlckRvd24gZXh0ZW5kcyBQb2ludGVyRXZlbnRDb21wb25lbnQge31cblxuLyoqXG4gKiBAcHVibGljXG4gKi9cbkBDb21wb25lbnQoJ3BvaW50ZXJVcCcpXG5leHBvcnQgY2xhc3MgR2xvYmFsUG9pbnRlclVwIGV4dGVuZHMgUG9pbnRlckV2ZW50Q29tcG9uZW50IHt9XG5cbi8qKlxuICogQHB1YmxpY1xuICovXG5leHBvcnQgY2xhc3MgU3Vic2NyaXB0aW9uIHtcbiAgcHVibGljIGZuOiAoZTogTG9jYWxBY3Rpb25CdXR0b25FdmVudCkgPT4gdm9pZFxuICBwdWJsaWMgdXNlUmF5Y2FzdDogYm9vbGVhblxuXG4gIGNvbnN0cnVjdG9yKGZuOiAoZTogTG9jYWxBY3Rpb25CdXR0b25FdmVudCkgPT4gdm9pZCwgdXNlUmF5Y2FzdDogYm9vbGVhbikge1xuICAgIHRoaXMuZm4gPSBmblxuICAgIHRoaXMudXNlUmF5Y2FzdCA9IHVzZVJheWNhc3RcbiAgfVxufVxuXG4vKipcbiAqIEBwdWJsaWNcbiAqL1xuZXhwb3J0IGNsYXNzIElucHV0IHtcbiAgcHJpdmF0ZSBzdGF0aWMgX2luc3RhbmNlOiBJbnB1dFxuXG4gIC8vIEBpbnRlcm5hbFxuICBwcml2YXRlIGJ1dHRvbklkTWFwcGluZzogQWN0aW9uQnV0dG9uW10gPSBbXG4gICAgQWN0aW9uQnV0dG9uLlBPSU5URVIsXG4gICAgQWN0aW9uQnV0dG9uLlBSSU1BUlksXG4gICAgQWN0aW9uQnV0dG9uLlNFQ09OREFSWSxcbiAgICBBY3Rpb25CdXR0b24uQU5ZLFxuICAgIEFjdGlvbkJ1dHRvbi5GT1JXQVJELFxuICAgIEFjdGlvbkJ1dHRvbi5CQUNLV0FSRCxcbiAgICBBY3Rpb25CdXR0b24uUklHSFQsXG4gICAgQWN0aW9uQnV0dG9uLkxFRlQsXG4gICAgQWN0aW9uQnV0dG9uLkpVTVAsXG4gICAgQWN0aW9uQnV0dG9uLldBTEssXG4gICAgQWN0aW9uQnV0dG9uLkFDVElPTl8zLFxuICAgIEFjdGlvbkJ1dHRvbi5BQ1RJT05fNCxcbiAgICBBY3Rpb25CdXR0b24uQUNUSU9OXzUsXG4gICAgQWN0aW9uQnV0dG9uLkFDVElPTl82XG4gIF1cblxuICBzdGF0aWMgZ2V0IGluc3RhbmNlKCk6IElucHV0IHtcbiAgICBJbnB1dC5lbnN1cmVJbnN0YW5jZSgpXG4gICAgcmV0dXJuIElucHV0Ll9pbnN0YW5jZVxuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uczogUmVjb3JkPFxuICAgIEFjdGlvbkJ1dHRvbixcbiAgICBSZWNvcmQ8SW5wdXRFdmVudEtpbmQsIEFycmF5PFN1YnNjcmlwdGlvbj4+XG4gID4gPSB0aGlzLmJ1dHRvbklkTWFwcGluZy5yZWR1Y2UoXG4gICAgKGFjYywgaykgPT4gKHsgLi4uYWNjLCBba106IHsgQlVUVE9OX0RPV046IFtdLCBCVVRUT05fVVA6IFtdIH0gfSksXG4gICAge30gYXMgUmVjb3JkPEFjdGlvbkJ1dHRvbiwgUmVjb3JkPElucHV0RXZlbnRLaW5kLCBBcnJheTxTdWJzY3JpcHRpb24+Pj5cbiAgKVxuXG4gIHByaXZhdGUgaW50ZXJuYWxTdGF0ZTogSW5wdXRTdGF0ZSA9IHRoaXMuYnV0dG9uSWRNYXBwaW5nLnJlZHVjZShcbiAgICAoYWNjLCBrKSA9PiAoeyAuLi5hY2MsIFtrXTogeyBCVVRUT05fRE9XTjogZmFsc2UgfSB9KSxcbiAgICB7fSBhcyBJbnB1dFN0YXRlXG4gIClcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKCkge31cblxuICBzdGF0aWMgZW5zdXJlSW5zdGFuY2UoKTogYW55IHtcbiAgICBpZiAoIUlucHV0Ll9pbnN0YW5jZSkge1xuICAgICAgSW5wdXQuX2luc3RhbmNlID0gbmV3IElucHV0KClcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQWxsb3dzIHRvIGtub3cgaWYgYSBidXR0b24gaXMgcHJlc3NlZFxuICAgKlxuICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGJ1dHRvbiBpcyBwcmVzc2VkXG4gICAqIEBwYXJhbSBidXR0b25JZCAtIFRoZSBpZCBvZiB0aGUgYnV0dG9uLlxuICAgKi9cbiAgcHVibGljIGlzQnV0dG9uUHJlc3NlZChidXR0b25JZDogQWN0aW9uQnV0dG9uKSB7XG4gICAgcmV0dXJuIHRoaXMuaW50ZXJuYWxTdGF0ZVtidXR0b25JZF1cbiAgfVxuXG4gIC8qKlxuICAgKiBTdWJzY3JpYmVzIHRvIGFuIGlucHV0IGV2ZW50IGFuZCB0cmlnZ2VycyB0aGUgcHJvdmlkZWQgY2FsbGJhY2suXG4gICAqXG4gICAqIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGNhbiBiZSBjYWxsZWQgdG8gcmVtb3ZlIHRoZSBzdWJzY3JpcHRpb24uXG4gICAqIEBwYXJhbSBldmVudE5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQgKHNlZSBJbnB1dEV2ZW50S2luZCkuXG4gICAqIEBwYXJhbSBidXR0b25JZCAtIFRoZSBpZCBvZiB0aGUgYnV0dG9uLlxuICAgKiBAcGFyYW0gdXNlUmF5Y2FzdCAtIEVuYWJsZXMgZ2V0dGluZyByYXljYXN0IGluZm9ybWF0aW9uLlxuICAgKiBAcGFyYW0gZm4gLSBBIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudCBpcyB0cmlnZ2VyZWQuXG4gICAqL1xuICBwdWJsaWMgc3Vic2NyaWJlKFxuICAgIGV2ZW50TmFtZTogSW5wdXRFdmVudEtpbmQsXG4gICAgYnV0dG9uSWQ6IEFjdGlvbkJ1dHRvbixcbiAgICB1c2VSYXljYXN0OiBib29sZWFuLFxuICAgIGZuOiAoZTogTG9jYWxBY3Rpb25CdXR0b25FdmVudCkgPT4gdm9pZFxuICApOiAoKSA9PiB2b2lkIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnNbYnV0dG9uSWRdW2V2ZW50TmFtZV0ucHVzaChcbiAgICAgIG5ldyBTdWJzY3JpcHRpb24oZm4sIHVzZVJheWNhc3QpXG4gICAgKVxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICB0aGlzLnVuc3Vic2NyaWJlKGV2ZW50TmFtZSwgYnV0dG9uSWQsIGZuKVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIGFuIGV4aXN0aW5nIGlucHV0IGV2ZW50IHN1YnNjcmlwdGlvbi5cbiAgICogQHBhcmFtIGV2ZW50TmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBldmVudCAoc2VlIElucHV0RXZlbnRLaW5kKS5cbiAgICogQHBhcmFtIGJ1dHRvbklkIC0gVGhlIGlkIG9mIHRoZSBidXR0b24uXG4gICAqIEBwYXJhbSBmbiAtIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB1c2VkIHdoZW4gc3Vic2NyaWJpbmcgdG8gdGhlIGV2ZW50LlxuICAgKi9cbiAgcHVibGljIHVuc3Vic2NyaWJlKFxuICAgIGV2ZW50TmFtZTogSW5wdXRFdmVudEtpbmQsXG4gICAgYnV0dG9uSWQ6IEFjdGlvbkJ1dHRvbixcbiAgICBmbjogKGU6IExvY2FsQWN0aW9uQnV0dG9uRXZlbnQpID0+IHZvaWRcbiAgKSB7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmdldFN1YnNjcmlwdGlvbklkKGV2ZW50TmFtZSwgYnV0dG9uSWQsIGZuKVxuICAgIGlmIChpbmRleCA+IC0xKSB7XG4gICAgICByZXR1cm4gdGhpcy5zdWJzY3JpcHRpb25zW2J1dHRvbklkXVtldmVudE5hbWVdLnNwbGljZShpbmRleCwgMSlcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBwdWJsaWMgaGFuZGxlUG9pbnRlckV2ZW50KGRhdGE6IEdsb2JhbElucHV0RXZlbnRSZXN1bHQpIHtcbiAgICBjb25zdCBidXR0b24gPSB0aGlzLmdldFBvaW50ZXJCeUlkKGRhdGEuYnV0dG9uSWQpXG5cbiAgICBpZiAoIWJ1dHRvbikge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgY29uc3QgZXZlbnRSZXN1bHQ6IExvY2FsQWN0aW9uQnV0dG9uRXZlbnQgPSB7XG4gICAgICAuLi5kYXRhLFxuICAgICAgYnV0dG9uLFxuICAgICAgZGlyZWN0aW9uOiBuZXcgVmVjdG9yMygpLmNvcHlGcm9tKGRhdGEuZGlyZWN0aW9uKSxcbiAgICAgIG9yaWdpbjogbmV3IFZlY3RvcjMoKS5jb3B5RnJvbShkYXRhLm9yaWdpbiksXG4gICAgICBoaXQ6IHVuZGVmaW5lZFxuICAgIH1cblxuICAgIGNvbnN0IGhpdCA9IGRhdGEuaGl0XG4gICAgICA/IHtcbiAgICAgICAgICAuLi5kYXRhLmhpdCxcbiAgICAgICAgICBoaXRQb2ludDogbmV3IFZlY3RvcjMoKS5jb3B5RnJvbShkYXRhLmhpdC5oaXRQb2ludCksXG4gICAgICAgICAgbm9ybWFsOiBuZXcgVmVjdG9yMygpLmNvcHlGcm9tKGRhdGEuaGl0Lm5vcm1hbCksXG4gICAgICAgICAgd29ybGROb3JtYWw6IG5ldyBWZWN0b3IzKCkuY29weUZyb20oZGF0YS5oaXQud29ybGROb3JtYWwpXG4gICAgICAgIH1cbiAgICAgIDogdW5kZWZpbmVkXG5cbiAgICBpZiAoZGF0YS50eXBlID09PSBJbnB1dEV2ZW50VHlwZS5ET1dOKSB7XG4gICAgICB0aGlzLmludGVybmFsU3RhdGVbYnV0dG9uXS5CVVRUT05fRE9XTiA9IHRydWVcblxuICAgICAgZm9yIChcbiAgICAgICAgbGV0IGkgPSAwO1xuICAgICAgICBpIDwgdGhpcy5zdWJzY3JpcHRpb25zW2J1dHRvbl1bJ0JVVFRPTl9ET1dOJ10ubGVuZ3RoO1xuICAgICAgICBpKytcbiAgICAgICkge1xuICAgICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLnN1YnNjcmlwdGlvbnNbYnV0dG9uXVsnQlVUVE9OX0RPV04nXVtpXVxuXG4gICAgICAgIC8vIHJlbW92ZSBoaXQgaW5mb3JtYXRpb24gd2hlbiByYXljYXN0IGlzIGRpc2FibGVkXG4gICAgICAgIGlmIChzdWJzY3JpcHRpb24udXNlUmF5Y2FzdCkge1xuICAgICAgICAgIGV2ZW50UmVzdWx0LmhpdCA9IGhpdFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGV2ZW50UmVzdWx0LmhpdCA9IHVuZGVmaW5lZFxuICAgICAgICB9XG5cbiAgICAgICAgc3Vic2NyaXB0aW9uLmZuKGV2ZW50UmVzdWx0KVxuICAgICAgfVxuXG4gICAgICBpZiAoaGl0ICYmIGhpdC5lbnRpdHlJZCAmJiBEaXNwb3NhYmxlQ29tcG9uZW50LmVuZ2luZSkge1xuICAgICAgICBjb25zdCBlbnRpdHkgPSBEaXNwb3NhYmxlQ29tcG9uZW50LmVuZ2luZS5lbnRpdGllc1toaXQuZW50aXR5SWRdXG4gICAgICAgIGNvbnN0IGhhbmRsZXIgPSBlbnRpdHkgJiYgZW50aXR5LmdldENvbXBvbmVudE9yTnVsbChHbG9iYWxQb2ludGVyRG93bilcbiAgICAgICAgaWYgKGhhbmRsZXIpIHtcbiAgICAgICAgICBldmVudFJlc3VsdC5oaXQgPSBoaXRcbiAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGV2ZW50UmVzdWx0KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaW50ZXJuYWxTdGF0ZVtidXR0b25dLkJVVFRPTl9ET1dOID0gZmFsc2VcblxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnN1YnNjcmlwdGlvbnNbYnV0dG9uXVsnQlVUVE9OX1VQJ10ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy5zdWJzY3JpcHRpb25zW2J1dHRvbl1bJ0JVVFRPTl9VUCddW2ldXG5cbiAgICAgICAgLy8gcmVtb3ZlIGhpdCBpbmZvcm1hdGlvbiB3aGVuIHJheWNhc3QgaXMgZGlzYWJsZWRcbiAgICAgICAgaWYgKHN1YnNjcmlwdGlvbi51c2VSYXljYXN0KSB7XG4gICAgICAgICAgZXZlbnRSZXN1bHQuaGl0ID0gaGl0XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZXZlbnRSZXN1bHQuaGl0ID0gdW5kZWZpbmVkXG4gICAgICAgIH1cblxuICAgICAgICBzdWJzY3JpcHRpb24uZm4oZXZlbnRSZXN1bHQpXG4gICAgICB9XG5cbiAgICAgIGlmIChoaXQgJiYgaGl0LmVudGl0eUlkICYmIERpc3Bvc2FibGVDb21wb25lbnQuZW5naW5lKSB7XG4gICAgICAgIGNvbnN0IGVudGl0eSA9IERpc3Bvc2FibGVDb21wb25lbnQuZW5naW5lLmVudGl0aWVzW2hpdC5lbnRpdHlJZF1cbiAgICAgICAgY29uc3QgaGFuZGxlciA9IGVudGl0eSAmJiBlbnRpdHkuZ2V0Q29tcG9uZW50T3JOdWxsKEdsb2JhbFBvaW50ZXJVcClcbiAgICAgICAgaWYgKGhhbmRsZXIpIHtcbiAgICAgICAgICBldmVudFJlc3VsdC5oaXQgPSBoaXRcbiAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGV2ZW50UmVzdWx0KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRTdWJzY3JpcHRpb25JZChcbiAgICBldmVudE5hbWU6IElucHV0RXZlbnRLaW5kLFxuICAgIGJ1dHRvbklkOiBBY3Rpb25CdXR0b24sXG4gICAgZm46IChlOiBMb2NhbEFjdGlvbkJ1dHRvbkV2ZW50KSA9PiB2b2lkXG4gICk6IG51bWJlciB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnN1YnNjcmlwdGlvbnNbYnV0dG9uSWRdW2V2ZW50TmFtZV0ubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbnNbYnV0dG9uSWRdW2V2ZW50TmFtZV1baV0uZm4gPT09IGZuKSB7XG4gICAgICAgIHJldHVybiBpXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIC0xXG4gIH1cblxuICBwcml2YXRlIGdldFBvaW50ZXJCeUlkKGlkOiBudW1iZXIpOiBBY3Rpb25CdXR0b24gfCBudWxsIHtcbiAgICBpZiAoaWQgPCAwIHx8IGlkID49IHRoaXMuYnV0dG9uSWRNYXBwaW5nLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG5cbiAgICBjb25zdCBhY3Rpb25CdXR0b24gPSB0aGlzLmJ1dHRvbklkTWFwcGluZ1tpZF1cblxuICAgIGlmIChhY3Rpb25CdXR0b24gPT09IEFjdGlvbkJ1dHRvbi5BTlkpIHtcbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuXG4gICAgcmV0dXJuIGFjdGlvbkJ1dHRvblxuICB9XG59XG4iXX0=