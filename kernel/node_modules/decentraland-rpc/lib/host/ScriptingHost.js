import { TransportBasedServer } from './TransportBasedServer';
import { hasOwnSymbol } from '../common/core/SymbolShim';
const hasSymbol = typeof Symbol === 'function' && Symbol.for;
const apiNameSymbol = hasSymbol ? Symbol('pluginName') : 0xfea2;
const registeredAPIs = {};
export function setAPIName(apiName, api) {
    const hasName = hasOwnSymbol(api, apiNameSymbol);
    if (hasName) {
        throw new Error(`The API you are trying to register is already registered`);
    }
    if (apiName in registeredAPIs) {
        throw new Error(`The API ${apiName} is already registered`);
    }
    if (typeof api !== 'function') {
        throw new Error(`The API ${apiName} is not a class, it is of type ${typeof api}`);
    }
    ;
    api[apiNameSymbol] = apiName;
}
var PrivateHelpers;
(function (PrivateHelpers) {
    function _registerAPI(apiName, api) {
        setAPIName(apiName, api);
        registeredAPIs[apiName] = api;
    }
    PrivateHelpers._registerAPI = _registerAPI;
    function unmountAPI(api) {
        if (api.apiWillUnmount) {
            const promise = api.apiWillUnmount();
            if (promise && 'catch' in promise) {
                promise.catch(error => console.error('Error unmounting API', { api, error }));
            }
        }
    }
    PrivateHelpers.unmountAPI = unmountAPI;
    function mountAPI(api) {
        if (api.apiDidMount) {
            const promise = api.apiDidMount();
            if (promise && 'catch' in promise) {
                promise.catch(error => console.error('Error mounting API', { api, error }));
            }
        }
    }
    PrivateHelpers.mountAPI = mountAPI;
})(PrivateHelpers || (PrivateHelpers = {}));
export var ScriptingHostEvents;
(function (ScriptingHostEvents) {
    ScriptingHostEvents["systemWillUnmount"] = "systemWillUnmount";
    ScriptingHostEvents["systemWillEnable"] = "systemWillEnable";
    ScriptingHostEvents["systemDidUnmount"] = "systemDidUnmount";
})(ScriptingHostEvents || (ScriptingHostEvents = {}));
export function getAPIName(klass) {
    return klass[apiNameSymbol] || klass.name || null;
}
export function registerAPI(apiName) {
    return function (api) {
        PrivateHelpers._registerAPI(apiName, api);
    };
}
export class ScriptingHost extends TransportBasedServer {
    constructor(worker) {
        super(worker);
        this.unmounted = false;
        this.apiInstances = new Map();
        this.expose('LoadComponents', this.RPCLoadAPIs.bind(this));
    }
    static async fromTransport(transport) {
        return new ScriptingHost(transport);
    }
    enable() {
        this.emit(ScriptingHostEvents.systemWillEnable);
        this.apiInstances.forEach(PrivateHelpers.mountAPI);
        super.enable();
    }
    getAPIInstance(api) {
        if (typeof api === 'string') {
            if (this.apiInstances.has(api)) {
                return this.apiInstances.get(api);
            }
            if (api in registeredAPIs) {
                return this.initializeAPI(registeredAPIs[api]);
            }
            return null;
        }
        else if (typeof api === 'function') {
            const apiName = getAPIName(api);
            if (apiName !== null) {
                if (this.apiInstances.has(apiName)) {
                    return this.apiInstances.get(apiName);
                }
                return this.initializeAPI(api);
            }
        }
        throw Object.assign(new Error('Cannot get instance of the specified component'), { api });
    }
    unmount() {
        if (this.unmounted)
            return;
        this.notify('SIGKILL');
        this.emit(ScriptingHostEvents.systemWillUnmount);
        try {
            this.apiInstances.forEach(PrivateHelpers.unmountAPI);
            this.apiInstances.clear();
        }
        catch (e) {
            this.emit('error', e);
        }
        this.transport.close();
        this.emit(ScriptingHostEvents.systemDidUnmount);
        this.unmounted = true;
    }
    initializeAPI(ctor) {
        const apiName = getAPIName(ctor);
        if (apiName === null) {
            throw new Error('The plugin is not registered');
        }
        if (this.apiInstances.has(apiName)) {
            return this.apiInstances.get(apiName);
        }
        const apiOptions = {
            apiName,
            on: (event, handler) => this.on(`${apiName}.${event}`, handler),
            notify: (event, params) => this.notify(`${apiName}.${event}`, params),
            expose: (event, handler) => this.expose(`${apiName}.${event}`, handler),
            getAPIInstance: (name) => {
                return this.getAPIInstance(name);
            },
            system: this
        };
        const instance = ctor.factory ? ctor.factory(ctor, apiOptions) : new ctor(apiOptions);
        this.apiInstances.set(apiName, instance);
        if (this.isEnabled) {
            PrivateHelpers.mountAPI(instance);
        }
        return instance;
    }
    async RPCLoadAPIs(apiNames) {
        if (typeof apiNames !== 'object' || !(apiNames instanceof Array)) {
            throw new TypeError('RPCLoadComponents(names) name must be an array of strings');
        }
        const notFound = apiNames
            .map(name => ({ api: this.getAPIInstance(name), name }))
            .filter($ => $.api === null)
            .map($ => $.name);
        if (notFound.length) {
            const message = `Components not found ${notFound.join(',')}`;
            throw new TypeError(message);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0aW5nSG9zdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ob3N0L1NjcmlwdGluZ0hvc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFHN0QsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFBO0FBS3hELE1BQU0sU0FBUyxHQUFHLE9BQU8sTUFBTSxLQUFLLFVBQVUsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFBO0FBRTVELE1BQU0sYUFBYSxHQUFRLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUE7QUFFcEUsTUFBTSxjQUFjLEdBQThCLEVBQUUsQ0FBQTtBQUVwRCxNQUFNLFVBQVUsVUFBVSxDQUFDLE9BQWUsRUFBRSxHQUFrQjtJQUM1RCxNQUFNLE9BQU8sR0FBRyxZQUFZLENBQUMsR0FBRyxFQUFFLGFBQWEsQ0FBQyxDQUFBO0lBQ2hELElBQUksT0FBTyxFQUFFO1FBQ1gsTUFBTSxJQUFJLEtBQUssQ0FBQywwREFBMEQsQ0FBQyxDQUFBO0tBQzVFO0lBRUQsSUFBSSxPQUFPLElBQUksY0FBYyxFQUFFO1FBQzdCLE1BQU0sSUFBSSxLQUFLLENBQUMsV0FBVyxPQUFPLHdCQUF3QixDQUFDLENBQUE7S0FDNUQ7SUFFRCxJQUFJLE9BQVEsR0FBVyxLQUFLLFVBQVUsRUFBRTtRQUN0QyxNQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsT0FBTyxrQ0FBa0MsT0FBTyxHQUFHLEVBQUUsQ0FBQyxDQUFBO0tBQ2xGO0lBSUQsQ0FBQztJQUFDLEdBQVcsQ0FBQyxhQUFhLENBQUMsR0FBRyxPQUFPLENBQUE7QUFDeEMsQ0FBQztBQUVELElBQVUsY0FBYyxDQXdCdkI7QUF4QkQsV0FBVSxjQUFjO0lBQ3RCLFNBQWdCLFlBQVksQ0FBQyxPQUFlLEVBQUUsR0FBa0I7UUFD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dmVudERpc3BhdGNoZXInXG5pbXBvcnQgeyBUcmFuc3BvcnRCYXNlZFNlcnZlciB9IGZyb20gJy4vVHJhbnNwb3J0QmFzZWRTZXJ2ZXInXG5pbXBvcnQgeyBBUElDbGFzcywgQVBJLCBBUElPcHRpb25zIH0gZnJvbSAnLi9BUEknXG5pbXBvcnQgeyBTY3JpcHRpbmdUcmFuc3BvcnQgfSBmcm9tICcuLi9jb21tb24vanNvbi1ycGMvdHlwZXMnXG5pbXBvcnQgeyBoYXNPd25TeW1ib2wgfSBmcm9tICcuLi9jb21tb24vY29yZS9TeW1ib2xTaGltJ1xuXG4vLyBJZiB0aGVyZSBpcyBubyBuYXRpdmUgU3ltYm9sXG4vLyBub3IgcG9seWZpbGwsIHRoZW4gYSBwbGFpbiBudW1iZXIgaXMgdXNlZCBmb3IgcGVyZm9ybWFuY2UuXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbmNvbnN0IGhhc1N5bWJvbCA9IHR5cGVvZiBTeW1ib2wgPT09ICdmdW5jdGlvbicgJiYgU3ltYm9sLmZvclxuXG5jb25zdCBhcGlOYW1lU3ltYm9sOiBhbnkgPSBoYXNTeW1ib2wgPyBTeW1ib2woJ3BsdWdpbk5hbWUnKSA6IDB4ZmVhMlxuXG5jb25zdCByZWdpc3RlcmVkQVBJczogRGljdGlvbmFyeTxBUElDbGFzczxBUEk+PiA9IHt9XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRBUElOYW1lKGFwaU5hbWU6IHN0cmluZywgYXBpOiBBUElDbGFzczxBUEk+KSB7XG4gIGNvbnN0IGhhc05hbWUgPSBoYXNPd25TeW1ib2woYXBpLCBhcGlOYW1lU3ltYm9sKVxuICBpZiAoaGFzTmFtZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIEFQSSB5b3UgYXJlIHRyeWluZyB0byByZWdpc3RlciBpcyBhbHJlYWR5IHJlZ2lzdGVyZWRgKVxuICB9XG5cbiAgaWYgKGFwaU5hbWUgaW4gcmVnaXN0ZXJlZEFQSXMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBBUEkgJHthcGlOYW1lfSBpcyBhbHJlYWR5IHJlZ2lzdGVyZWRgKVxuICB9XG5cbiAgaWYgKHR5cGVvZiAoYXBpIGFzIGFueSkgIT09ICdmdW5jdGlvbicpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBBUEkgJHthcGlOYW1lfSBpcyBub3QgYSBjbGFzcywgaXQgaXMgb2YgdHlwZSAke3R5cGVvZiBhcGl9YClcbiAgfVxuXG4gIC8vIHNhdmUgdGhlIHJlZ2lzdGVyZWQgbmFtZVxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c2VtaWNvbG9uXG4gIDsoYXBpIGFzIGFueSlbYXBpTmFtZVN5bWJvbF0gPSBhcGlOYW1lXG59XG5cbm5hbWVzcGFjZSBQcml2YXRlSGVscGVycyB7XG4gIGV4cG9ydCBmdW5jdGlvbiBfcmVnaXN0ZXJBUEkoYXBpTmFtZTogc3RyaW5nLCBhcGk6IEFQSUNsYXNzPEFQST4pIHtcbiAgICBzZXRBUElOYW1lKGFwaU5hbWUsIGFwaSlcblxuICAgIHJlZ2lzdGVyZWRBUElzW2FwaU5hbWVdID0gYXBpXG4gIH1cblxuICBleHBvcnQgZnVuY3Rpb24gdW5tb3VudEFQSShhcGk6IEFQSSkge1xuICAgIGlmIChhcGkuYXBpV2lsbFVubW91bnQpIHtcbiAgICAgIGNvbnN0IHByb21pc2UgPSBhcGkuYXBpV2lsbFVubW91bnQoKVxuICAgICAgaWYgKHByb21pc2UgJiYgJ2NhdGNoJyBpbiBwcm9taXNlKSB7XG4gICAgICAgIHByb21pc2UuY2F0Y2goZXJyb3IgPT4gY29uc29sZS5lcnJvcignRXJyb3IgdW5tb3VudGluZyBBUEknLCB7IGFwaSwgZXJyb3IgfSkpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZXhwb3J0IGZ1bmN0aW9uIG1vdW50QVBJKGFwaTogQVBJKSB7XG4gICAgaWYgKGFwaS5hcGlEaWRNb3VudCkge1xuICAgICAgY29uc3QgcHJvbWlzZSA9IGFwaS5hcGlEaWRNb3VudCgpXG4gICAgICBpZiAocHJvbWlzZSAmJiAnY2F0Y2gnIGluIHByb21pc2UpIHtcbiAgICAgICAgcHJvbWlzZS5jYXRjaChlcnJvciA9PiBjb25zb2xlLmVycm9yKCdFcnJvciBtb3VudGluZyBBUEknLCB7IGFwaSwgZXJyb3IgfSkpXG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8vIEhFUkUgV0UgU1RBUlQgVEhFIEVYUE9SVFNcblxuZXhwb3J0IGVudW0gU2NyaXB0aW5nSG9zdEV2ZW50cyB7XG4gIHN5c3RlbVdpbGxVbm1vdW50ID0gJ3N5c3RlbVdpbGxVbm1vdW50JyxcbiAgc3lzdGVtV2lsbEVuYWJsZSA9ICdzeXN0ZW1XaWxsRW5hYmxlJyxcbiAgc3lzdGVtRGlkVW5tb3VudCA9ICdzeXN0ZW1EaWRVbm1vdW50J1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QVBJTmFtZShrbGFzczogQVBJQ2xhc3M8QVBJPik6IHN0cmluZyB8IG51bGwge1xuICByZXR1cm4gKGtsYXNzIGFzIGFueSlbYXBpTmFtZVN5bWJvbF0gfHwga2xhc3MubmFtZSB8fCBudWxsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWdpc3RlckFQSShhcGlOYW1lOiBzdHJpbmcpOiAoa2xhc3M6IEFQSUNsYXNzPEFQST4pID0+IHZvaWQge1xuICByZXR1cm4gZnVuY3Rpb24oYXBpOiBBUElDbGFzczxBUEk+KSB7XG4gICAgUHJpdmF0ZUhlbHBlcnMuX3JlZ2lzdGVyQVBJKGFwaU5hbWUsIGFwaSlcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgU2NyaXB0aW5nSG9zdCBleHRlbmRzIFRyYW5zcG9ydEJhc2VkU2VydmVyIHtcbiAgdW5tb3VudGVkID0gZmFsc2VcblxuICBhcGlJbnN0YW5jZXM6IE1hcDxzdHJpbmcsIEFQST4gPSBuZXcgTWFwKClcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKHdvcmtlcjogU2NyaXB0aW5nVHJhbnNwb3J0KSB7XG4gICAgc3VwZXIod29ya2VyKVxuXG4gICAgdGhpcy5leHBvc2UoJ0xvYWRDb21wb25lbnRzJywgdGhpcy5SUENMb2FkQVBJcy5iaW5kKHRoaXMpKVxuICB9XG5cbiAgc3RhdGljIGFzeW5jIGZyb21UcmFuc3BvcnQodHJhbnNwb3J0OiBTY3JpcHRpbmdUcmFuc3BvcnQpIHtcbiAgICByZXR1cm4gbmV3IFNjcmlwdGluZ0hvc3QodHJhbnNwb3J0KVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aGRvZCBzaG91bGQgYmUgY2FsbGVkIG9ubHkgZnJvbSB0aGUgaW50ZXJmYWNlIHRoYXQgbWFuYWdlcyB0aGUgU2NyaXB0aW5nSG9zdHMuXG4gICAqIEl0IGluaXRpYWxpemVzIHRoZSBzeXN0ZW0gYW5kIGl0J3MgcXVldWVkIGNvbXBvbmVudHMuIEl0IGFsc28gc2VuZHMgYSBmaXJzdCBub3RpZmljYXRpb25cbiAgICogdG8gdGhlIGltcGxlbWVudGF0aW9uIG9mIHRoZSBzeXN0ZW0gdGVsbGluZyBpdCBpcyBub3cgZW5hYmxlZC4gSW4gdGhhdCBtb21lbnQsIHRoZVxuICAgKiBpbXBsZW1lbnRhdGlvbiB3aWxsIHNlbmQgdGhlIHF1ZXVlZCBtZXNzYWdlcyBhbmQgZXhlY3V0ZSB0aGUgcXVldWVkIG1ldGhvZHMgYWdhaW5zdCB0aGVcbiAgICogbWF0ZXJpYWxpemVkIGNvbXBvbmVudHMuXG4gICAqXG4gICAqIEl0OlxuICAgKiAgMSkgZW1pdHMgYSBDb21wb25lbnRTeXN0ZW1FdmVudHMuc3lzdGVtV2lsbEVuYWJsZSBldmVudFxuICAgKiAgMikgbW91bnRzIGFsbCB0aGUgY29tcG9uZW50c1xuICAgKiAgMykgc2VuZHMgdGhlIG5vdGlmaWNhdGlvbiB0byB0aGUgYWN0dWFsIHN5c3RlbSBpbXBsZW1lbnRhdGlvblxuICAgKi9cbiAgZW5hYmxlKCkge1xuICAgIHRoaXMuZW1pdChTY3JpcHRpbmdIb3N0RXZlbnRzLnN5c3RlbVdpbGxFbmFibGUpXG4gICAgdGhpcy5hcGlJbnN0YW5jZXMuZm9yRWFjaChQcml2YXRlSGVscGVycy5tb3VudEFQSSlcbiAgICBzdXBlci5lbmFibGUoKVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgaXMgYSBzZXJ2aWNlIGxvY2F0b3IsIGl0IGxvY2F0ZXMgb3IgaW5zdGFudGlhdGUgdGhlIHJlcXVlc3RlZCBjb21wb25lbnRcbiAgICogZm9yIHRoaXMgaW5zdGFuY2Ugb2YgQ29tcG9uZW50U3lzdGVtLlxuICAgKlxuICAgKiBAcGFyYW0gYXBpIEEgY2xhc3MgY29uc3RydWN0b3JcbiAgICovXG4gIGdldEFQSUluc3RhbmNlPFg+KGFwaTogeyBuZXcgKG9wdGlvbnM6IEFQSU9wdGlvbnMpOiBYIH0pOiBYXG5cbiAgLyoqXG4gICAqIFRoaXMgaXMgYSBzZXJ2aWNlIGxvY2F0b3IsIGl0IGxvY2F0ZXMgb3IgaW5zdGFudGlhdGUgdGhlIHJlcXVlc3RlZCBjb21wb25lbnRcbiAgICogZm9yIHRoaXMgaW5zdGFuY2Ugb2YgQ29tcG9uZW50U3lzdGVtLlxuICAgKlxuICAgKiBAcGFyYW0gbmFtZSBUaGUgbmFtZSBvZiB1c2VkIHRvIHJlZ2lzdGVyIHRoZSBjb21wb25lbnRcbiAgICovXG4gIGdldEFQSUluc3RhbmNlKG5hbWU6IHN0cmluZyk6IEFQSSB8IG51bGxcblxuICBnZXRBUElJbnN0YW5jZShhcGk6IGFueSkge1xuICAgIGlmICh0eXBlb2YgYXBpID09PSAnc3RyaW5nJykge1xuICAgICAgaWYgKHRoaXMuYXBpSW5zdGFuY2VzLmhhcyhhcGkpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaUluc3RhbmNlcy5nZXQoYXBpKVxuICAgICAgfVxuICAgICAgaWYgKGFwaSBpbiByZWdpc3RlcmVkQVBJcykge1xuICAgICAgICByZXR1cm4gdGhpcy5pbml0aWFsaXplQVBJKHJlZ2lzdGVyZWRBUElzW2FwaV0pXG4gICAgICB9XG4gICAgICByZXR1cm4gbnVsbFxuICAgIH0gZWxzZSBpZiAodHlwZW9mIGFwaSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgY29uc3QgYXBpTmFtZSA9IGdldEFQSU5hbWUoYXBpKVxuXG4gICAgICAvLyBpZiBpdCBoYXMgYSBuYW1lLCB1c2UgdGhhdCBpbmRpcmVjdGlvbiB0byBmaW5kIGluIHRoZSBpbnN0YW5jZSdzIG1hcFxuICAgICAgaWYgKGFwaU5hbWUgIT09IG51bGwpIHtcbiAgICAgICAgaWYgKHRoaXMuYXBpSW5zdGFuY2VzLmhhcyhhcGlOYW1lKSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLmFwaUluc3RhbmNlcy5nZXQoYXBpTmFtZSlcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIElmIHdlIGRvbid0IGhhdmUgYSBsb2NhbCBpbnN0YW5jZSwgY3JlYXRlIHRoZSBpbnN0YW5jZSBvZiB0aGUgY29tcG9uZW50XG4gICAgICAgIHJldHVybiB0aGlzLmluaXRpYWxpemVBUEkoYXBpKVxuICAgICAgfVxuICAgIH1cblxuICAgIHRocm93IE9iamVjdC5hc3NpZ24obmV3IEVycm9yKCdDYW5ub3QgZ2V0IGluc3RhbmNlIG9mIHRoZSBzcGVjaWZpZWQgY29tcG9uZW50JyksIHsgYXBpIH0pXG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgdW5tb3VudHMgYWxsIHRoZSBjb21wb25lbnRzIGFuZCByZWxlYXNlcyB0aGUgV29ya2VyXG4gICAqL1xuICB1bm1vdW50KCkge1xuICAgIGlmICh0aGlzLnVubW91bnRlZCkgcmV0dXJuXG4gICAgdGhpcy5ub3RpZnkoJ1NJR0tJTEwnKVxuXG4gICAgdGhpcy5lbWl0KFNjcmlwdGluZ0hvc3RFdmVudHMuc3lzdGVtV2lsbFVubW91bnQpXG5cbiAgICB0cnkge1xuICAgICAgdGhpcy5hcGlJbnN0YW5jZXMuZm9yRWFjaChQcml2YXRlSGVscGVycy51bm1vdW50QVBJKVxuICAgICAgdGhpcy5hcGlJbnN0YW5jZXMuY2xlYXIoKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlKVxuICAgIH1cblxuICAgIHRoaXMudHJhbnNwb3J0LmNsb3NlKClcblxuICAgIHRoaXMuZW1pdChTY3JpcHRpbmdIb3N0RXZlbnRzLnN5c3RlbURpZFVubW91bnQpXG5cbiAgICB0aGlzLnVubW91bnRlZCA9IHRydWVcbiAgfVxuXG4gIHByb3RlY3RlZCBpbml0aWFsaXplQVBJPFggZXh0ZW5kcyBBUEk+KGN0b3I6IHtcbiAgICBuZXcgKG9wdGlvbnM6IEFQSU9wdGlvbnMpOiBYXG4gICAgZmFjdG9yeT8oY3RvcjogeyBuZXcgKG9wdGlvbnM6IEFQSU9wdGlvbnMpOiBYIH0sIG9wdGlvbnM6IEFQSU9wdGlvbnMpOiBYXG4gIH0pOiBYIHtcbiAgICBjb25zdCBhcGlOYW1lID0gZ2V0QVBJTmFtZShjdG9yKVxuXG4gICAgaWYgKGFwaU5hbWUgPT09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIHBsdWdpbiBpcyBub3QgcmVnaXN0ZXJlZCcpXG4gICAgfVxuXG4gICAgaWYgKHRoaXMuYXBpSW5zdGFuY2VzLmhhcyhhcGlOYW1lKSkge1xuICAgICAgcmV0dXJuIHRoaXMuYXBpSW5zdGFuY2VzLmdldChhcGlOYW1lKSBhcyBYXG4gICAgfVxuXG4gICAgY29uc3QgYXBpT3B0aW9uczogQVBJT3B0aW9ucyA9IHtcbiAgICAgIGFwaU5hbWUsXG4gICAgICBvbjogKGV2ZW50LCBoYW5kbGVyKSA9PiB0aGlzLm9uKGAke2FwaU5hbWV9LiR7ZXZlbnR9YCwgaGFuZGxlciksXG4gICAgICBub3RpZnk6IChldmVudCwgcGFyYW1zPykgPT4gdGhpcy5ub3RpZnkoYCR7YXBpTmFtZX0uJHtldmVudH1gLCBwYXJhbXMpLFxuICAgICAgZXhwb3NlOiAoZXZlbnQsIGhhbmRsZXIpID0+IHRoaXMuZXhwb3NlKGAke2FwaU5hbWV9LiR7ZXZlbnR9YCwgaGFuZGxlciksXG4gICAgICBnZXRBUElJbnN0YW5jZTogKG5hbWU6IGFueSkgPT4ge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QVBJSW5zdGFuY2UobmFtZSkgYXMgYW55XG4gICAgICB9LFxuICAgICAgc3lzdGVtOiB0aGlzXG4gICAgfVxuXG4gICAgY29uc3QgaW5zdGFuY2UgPSBjdG9yLmZhY3RvcnkgPyBjdG9yLmZhY3RvcnkoY3RvciwgYXBpT3B0aW9ucykgOiBuZXcgY3RvcihhcGlPcHRpb25zKVxuXG4gICAgdGhpcy5hcGlJbnN0YW5jZXMuc2V0KGFwaU5hbWUsIGluc3RhbmNlKVxuXG4gICAgaWYgKHRoaXMuaXNFbmFibGVkKSB7XG4gICAgICBQcml2YXRlSGVscGVycy5tb3VudEFQSShpbnN0YW5jZSlcbiAgICB9XG5cbiAgICByZXR1cm4gaW5zdGFuY2VcbiAgfVxuXG4gIC8qKlxuICAgKiBQcmVsb2FkcyBhIGxpc3Qgb2YgY29tcG9uZW50c1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBSUENMb2FkQVBJcyhhcGlOYW1lczogc3RyaW5nW10pIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbiAgICBpZiAodHlwZW9mIGFwaU5hbWVzICE9PSAnb2JqZWN0JyB8fCAhKGFwaU5hbWVzIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdSUENMb2FkQ29tcG9uZW50cyhuYW1lcykgbmFtZSBtdXN0IGJlIGFuIGFycmF5IG9mIHN0cmluZ3MnKVxuICAgIH1cblxuICAgIGNvbnN0IG5vdEZvdW5kID0gYXBpTmFtZXNcbiAgICAgIC5tYXAobmFtZSA9PiAoeyBhcGk6IHRoaXMuZ2V0QVBJSW5zdGFuY2UobmFtZSksIG5hbWUgfSkpXG4gICAgICAuZmlsdGVyKCQgPT4gJC5hcGkgPT09IG51bGwpXG4gICAgICAubWFwKCQgPT4gJC5uYW1lKVxuXG4gICAgaWYgKG5vdEZvdW5kLmxlbmd0aCkge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGBDb21wb25lbnRzIG5vdCBmb3VuZCAke25vdEZvdW5kLmpvaW4oJywnKX1gXG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKG1lc3NhZ2UpXG4gICAgfVxuICB9XG59XG4iXX0=